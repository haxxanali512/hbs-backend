<%= form_with(model: @support_ticket,
              url: (@support_ticket.persisted? ? tenant_support_ticket_path(@support_ticket) : tenant_support_tickets_path),
              local: true,
              multipart: true,
              class: "space-y-6") do |f| %>
  <% if @support_ticket.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(@support_ticket.errors.count, "error") %> prohibited this support ticket from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% @support_ticket.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Core Information -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Core Information</h3>
      
      <div>
        <%= f.label :category, "Category", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :category,
                     SupportTicket.category_options_for_select,
                     { prompt: "Select category" },
                     { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500", required: true } %>
      </div>

      <div id="claims-subcategory-field" class="hidden">
        <%= f.label :sub_category, "Subcategory", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :sub_category,
                     [],
                     { prompt: "Select subcategory" },
                     { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                       data: { current_value: @support_ticket.sub_category } } %>
        <p class="mt-1 text-sm text-gray-500" id="subcategory-help">Required for Claims Issue</p>
      </div>

      <div>
        <%= f.label :subject, "Subject", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :subject, maxlength: 200, class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        <p class="mt-1 text-sm text-gray-500">Avoid PHI. 200 characters max.</p>
      </div>
    </div>

    <!-- Additional Information -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Additional Information</h3>
      
      <div class="space-y-3">
        <div>
          <%= f.label :linked_resource_type, "Linked Resource", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :linked_resource_type,
                       [["None", ""]] + SupportTicket::LINKED_RESOURCE_TYPES.keys.map { |k| [k, k] },
                       {},
                       { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
          <%# <p class="mt-1 text-sm text-gray-500">Optional, must belong to your organization.</p> %>
        </div>

        <div id="linked-resource-picker" class="hidden space-y-3">
          <div id="linked-resource-patient-block" class="hidden">
            <%= label_tag :linked_patient_id, "Patient", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= select_tag :linked_patient_id,
                           options_from_collection_for_select(@patients, :id, :full_name),
                           include_blank: "Select patient...",
                           class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                           id: "support_ticket_patient_select" %>
          </div>

          <div>
            <%= label_tag :linked_resource_select, "Select Resource", class: "block text-sm font-medium text-gray-700 mb-1", id: "linked-resource-label" %>
            <%= select_tag :linked_resource_select,
                           options_for_select([]),
                           include_blank: "Select resource...",
                           class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                           id: "support_ticket_resource_select" %>
            <p class="mt-1 text-sm text-gray-500" id="linked-resource-help">Select a resource to link to this ticket.</p>
          </div>
        </div>
      </div>

      <%= f.hidden_field :linked_resource_id, id: "support_ticket_linked_resource_id" %>
    </div>
  </div>

<script>
  document.addEventListener("turbo:load", function() {
    const categorySelect = document.getElementById("support_ticket_category");
    const subcategoryField = document.getElementById("claims-subcategory-field");
    const subcategorySelect = document.getElementById("support_ticket_sub_category");
    const subcategoryHelp = document.getElementById("subcategory-help");
    const subcategoryOptions = <%= raw SupportTicket.subcategory_options_by_category.to_json %>;

    function toggleSubcategory() {
      if (!categorySelect || !subcategoryField) return;
      const category = categorySelect.value;
      const options = subcategoryOptions[category] || [];
      const requiresSubcategory = options.length > 0;

      subcategoryField.classList.toggle("hidden", !requiresSubcategory);
      if (!requiresSubcategory && subcategorySelect) {
        subcategorySelect.value = "";
      }
      if (subcategorySelect) subcategorySelect.required = requiresSubcategory;

      if (requiresSubcategory && subcategorySelect) {
        const currentValue = subcategorySelect.dataset.currentValue;
        subcategorySelect.innerHTML = '<option value="">Select subcategory</option>';
        options.forEach(function(opt) {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          if (currentValue && currentValue === opt.value) {
            option.selected = true;
          }
          subcategorySelect.appendChild(option);
        });
      }

      if (subcategoryHelp) {
        if (category === "claims_issue") subcategoryHelp.textContent = "Required for Claims Issue";
        else if (category === "portal_bug") subcategoryHelp.textContent = "Required for Portal & Tech tickets";
        else if (category === "access_request") subcategoryHelp.textContent = "Required for Access Requests";
      }
    }

    toggleSubcategory();
    if (categorySelect) {
      categorySelect.addEventListener("change", toggleSubcategory);
    }

    const resourceTypeSelect = document.getElementById("support_ticket_linked_resource_type");
    const patientBlock = document.getElementById("linked-resource-patient-block");
    const pickerBlock = document.getElementById("linked-resource-picker");
    const patientSelect = document.getElementById("support_ticket_patient_select");
    const resourceSelect = document.getElementById("support_ticket_resource_select");
    const resourceLabel = document.getElementById("linked-resource-label");
    const resourceHelp = document.getElementById("linked-resource-help");
    const linkedResourceId = document.getElementById("support_ticket_linked_resource_id");

    const patientScopedResources = ["Encounter", "Claim"];

    function resetResourceSelect() {
      if (!resourceSelect) return;
      resourceSelect.innerHTML = '<option value="">Select resource...</option>';
    }

    function toggleLinkedResourceUI() {
      if (!resourceTypeSelect || !pickerBlock) return;
      const resourceType = resourceTypeSelect.value;
      const hasResource = resourceType && resourceType.length > 0;
      pickerBlock.classList.toggle("hidden", !hasResource);

      if (!hasResource) {
        if (patientSelect) patientSelect.value = "";
        resetResourceSelect();
        if (linkedResourceId) linkedResourceId.value = "";
        return;
      }

      const needsPatient = patientScopedResources.includes(resourceType);
      if (patientBlock) patientBlock.classList.toggle("hidden", !needsPatient);
      if (resourceLabel) resourceLabel.textContent = resourceType;
      if (resourceHelp) {
        resourceHelp.textContent = needsPatient
          ? "Select a patient to load items, then choose one."
          : "Select a resource to link to this ticket.";
      }

      resetResourceSelect();
      if (!needsPatient) {
        loadResources(resourceType, null);
      }
    }

    async function loadResources(resourceType, patientId) {
      if (!resourceType) return;
      const url = "<%= linked_resources_tenant_support_tickets_path %>" +
        "?resource_type=" + encodeURIComponent(resourceType) +
        (patientId ? ("&patient_id=" + encodeURIComponent(patientId)) : "");

      const response = await fetch(url, { headers: { "Accept": "application/json" } });
      const data = await response.json();
      resetResourceSelect();
      if (!data.success) return;
      data.resources.forEach(function(item) {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.label;
        resourceSelect.appendChild(option);
      });
    }

    if (resourceTypeSelect) {
      toggleLinkedResourceUI();
      resourceTypeSelect.addEventListener("change", function() {
        if (linkedResourceId) linkedResourceId.value = "";
        if (patientSelect) patientSelect.value = "";
        toggleLinkedResourceUI();
      });
    }

    if (patientSelect) {
      patientSelect.addEventListener("change", function() {
        const resourceType = resourceTypeSelect ? resourceTypeSelect.value : "";
        if (!resourceType) return;
        loadResources(resourceType, patientSelect.value);
      });
    }

    if (resourceSelect) {
      resourceSelect.addEventListener("change", function() {
        if (linkedResourceId) linkedResourceId.value = resourceSelect.value || "";
      });
    }
  });
</script>
  <!-- Description -->
  <div class="space-y-4">
    <h3 class="text-lg font-medium text-gray-900">Description</h3>
    
    <div>
      <%= f.label :description, "Description", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.text_area :description, rows: 6, class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-sm text-gray-500">Do not include PHI. Share claim IDs or invoice numbers instead.</p>
    </div>
  </div>

  <!-- Attachments -->
  <div class="space-y-4">
    <h3 class="text-lg font-medium text-gray-900">Attachments</h3>
    
    <div>
      <%= f.label :documents, "Upload Files", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.file_field :documents,
                       multiple: true,
                       class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-sm text-gray-500">PDF, images, or office docs. Max 25MB.</p>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
    <%= link_to "Cancel", tenant_support_tickets_path, class: "bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors" %>
    <%= f.submit "Submit Ticket", class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors cursor-pointer" %>
  </div>
<% end %>

