<%= form_with model: [:tenant, org_accepted_plan], local: true, class: "space-y-6" do |f| %>
  <% if org_accepted_plan.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(org_accepted_plan.errors.count, "error") %> prohibited this plan from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% org_accepted_plan.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Core Information -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Core Information</h3>
      <div>
        <%= label_tag :payer_id, "Payer", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :payer_id,
            options_for_select([ [ "Select payer…", "" ] ] + Array(@payer_options), org_accepted_plan.insurance_plan&.payer_id),
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
              required: true,
              data: { plan_options_url: plan_options_tenant_org_accepted_plans_path } } %>
        <p class="mt-1 text-sm text-gray-500">Select a payer first to unlock plans below.</p>
      </div>
      <div>
        <%= f.label :insurance_plan_id, "Insurance Plan", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :insurance_plan_id, 
            options_for_select([]),
            { prompt: "Select plan…" },
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
              required: true,
              disabled: true,
              data: { accepted_plan_ids: @accepted_plan_ids.to_json, current_plan_id: org_accepted_plan.insurance_plan_id } } %>
        <p id="acceptedPlanDuplicateError" class="mt-1 text-sm text-red-600 hidden">
          This plan is already accepted for your organization.
        </p>
      </div>

      <div>
        <%= f.label :network_type, "Network Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :network_type, 
            options_for_select(OrgAcceptedPlan.network_types.keys.map { |k| [k.humanize, k] }, org_accepted_plan.network_type),
            {},
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500", required: true } %>
        <p class="mt-1 text-sm text-gray-500">In-network requires enrollment verification by HBS</p>
      </div>

      <div>
        <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :status, 
            options_for_select(OrgAcceptedPlan.statuses.keys.map { |k| [k.humanize, k] }, org_accepted_plan.status),
            {},
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500", required: true } %>
      </div>
    </div>

    <!-- Additional Information -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Additional Information</h3>
      
      <div>
        <%= f.label :effective_date, "Effective Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.date_field :effective_date, 
            class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
            required: true %>
      </div>

      <div>
        <%= f.label :end_date, "End Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.date_field :end_date, 
            class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        <p class="mt-1 text-sm text-gray-500">Optional; plan will auto-inactivate when reached</p>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="space-y-4">
    <h3 class="text-lg font-medium text-gray-900">Notes</h3>
    <div>
      <%= label_tag :note_body, "Add Note", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= text_area_tag :note_body, nil, rows: 4, class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-sm text-gray-500">New entries are appended to the note history.</p>
    </div>
    <% if org_accepted_plan.plan_notes.any? || org_accepted_plan.notes.present? %>
      <div class="space-y-2">
        <p class="text-sm font-medium text-gray-700">Previous Notes</p>
        <div class="space-y-3">
          <% if org_accepted_plan.notes.present? %>
            <div class="rounded-md border border-gray-200 p-3 text-sm text-gray-900 whitespace-pre-wrap">
              <%= org_accepted_plan.notes %>
            </div>
          <% end %>
          <% org_accepted_plan.plan_notes.each do |note| %>
            <div class="rounded-md border border-gray-200 p-3">
              <div class="text-xs text-gray-500 mb-1">
                <%= note.created_by&.display_name || "System" %> · <%= format_in_organization_tz(note.created_at, "%m/%d/%Y %I:%M %p") %>
              </div>
              <div class="text-sm text-gray-900 whitespace-pre-wrap"><%= note.body %></div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Form Actions -->
  <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
    <%= link_to "Cancel", org_accepted_plan.persisted? ? tenant_org_accepted_plan_path(org_accepted_plan) : tenant_org_accepted_plans_path, class: "bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors" %>
    <%= f.submit org_accepted_plan.persisted? ? "Update Plan" : "Accept Plan", class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors cursor-pointer", data: { role: "accepted-plan-submit" } %>
  </div>
<% end %>

<script>
  document.addEventListener("turbo:load", function() {
    const payerSelect = document.getElementById("payer_id");
    const planSelect = document.getElementById("org_accepted_plan_insurance_plan_id");
    const submitBtn = document.querySelector('[data-role="accepted-plan-submit"]');
    const errorEl = document.getElementById("acceptedPlanDuplicateError");

    if (!payerSelect || !planSelect || !submitBtn) return;

    const planOptionsUrl = payerSelect.dataset.planOptionsUrl || "";
    const acceptedPlanIds = planSelect.dataset.acceptedPlanIds
      ? JSON.parse(planSelect.dataset.acceptedPlanIds)
      : [];
    const currentPlanId = planSelect.dataset.currentPlanId;

    function isDuplicate(selectedId) {
      if (!selectedId) return false;
      if (currentPlanId && selectedId.toString() === currentPlanId.toString()) return false;
      return acceptedPlanIds.map(String).includes(selectedId.toString());
    }

    function updateDuplicateState() {
      const selectedId = planSelect.value;
      const duplicate = isDuplicate(selectedId);

      if (duplicate) {
        planSelect.setCustomValidity("This plan is already accepted.");
        submitBtn.disabled = true;
        submitBtn.classList.add("opacity-50", "cursor-not-allowed");
        if (errorEl) errorEl.classList.remove("hidden");
      } else {
        planSelect.setCustomValidity("");
        submitBtn.disabled = false;
        submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
        if (errorEl) errorEl.classList.add("hidden");
      }
    }

    function loadPlansForPayer() {
      const payerId = payerSelect.value;
      if (!payerId) {
        planSelect.innerHTML = '<option value="">Select plan…</option>';
        planSelect.disabled = true;
        updateDuplicateState();
        return;
      }
      const selectedPlanId = currentPlanId || "";
      const url = planOptionsUrl + "?payer_id=" + encodeURIComponent(payerId) + (selectedPlanId ? "&selected_plan_id=" + encodeURIComponent(selectedPlanId) : "");
      planSelect.disabled = true;
      planSelect.innerHTML = '<option value="">Loading…</option>';
      fetch(url, { headers: { "Accept": "text/html" } })
        .then(function(r) { return r.text(); })
        .then(function(html) {
          planSelect.innerHTML = html;
          planSelect.disabled = false;
          updateDuplicateState();
        })
        .catch(function() {
          planSelect.innerHTML = '<option value="">Error loading plans</option>';
          planSelect.disabled = false;
        });
    }

    payerSelect.addEventListener("change", function() {
      planSelect.value = "";
      loadPlansForPayer();
    });

    planSelect.addEventListener("change", updateDuplicateState);

    if (payerSelect.value) {
      loadPlansForPayer();
    } else {
      updateDuplicateState();
    }

    var form = planSelect.closest("form");
    if (form) {
      form.addEventListener("submit", function(e) {
        if (!payerSelect.value) {
          e.preventDefault();
          payerSelect.focus();
          return false;
        }
      });
    }
  });
</script>
