<div id="acceptPlansModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="acceptPlansModal-title" role="dialog" aria-modal="true">
  <div class="relative flex min-h-full items-center justify-center p-4">
    <div id="acceptPlansModalOverlay" class="absolute inset-0 bg-black/40 transition-opacity duration-300 ease-in-out" onclick="closeAcceptPlansModal()"></div>
    <div id="acceptPlansModalContent" class="relative z-10 w-full max-w-2xl rounded-lg bg-white shadow-xl transform transition-all duration-300 ease-in-out">
      <div class="bg-white px-6 py-8">
        <% all_providers = current_organization.providers.kept %>
        <% has_providers = all_providers.exists? %>
        <% approved_providers = all_providers.active %>
        <% pending_or_drafted_providers = all_providers.where(status: %w[drafted pending]) %>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900" id="acceptPlansModal-title">Accept insurance plans</h3>
          <button type="button" onclick="closeAcceptPlansModal()" class="text-gray-400 hover:text-gray-500">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <% unless has_providers %>
          <div class="mb-6 rounded-md border border-yellow-200 bg-yellow-50 p-4">
            <h4 class="text-sm font-semibold text-yellow-800 mb-1">
              Providers required before accepting plans
            </h4>
            <p class="text-sm text-yellow-700 mb-3">
              You must create at least one provider for your organization before accepting insurance plans. 
              Providers are required so Holistic Business Services can complete payer enrollment for billing.
            </p>
            <%= link_to "Create Provider",
                        new_tenant_provider_path,
                        class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700" %>
          </div>
        <% end %>

        <% if has_providers %>
          <div class="mb-4 space-y-3">
            <div>
              <label for="accept_plans_payer_id" class="block text-sm font-medium text-gray-700 mb-1">
                Payer <span class="text-red-500">*</span>
              </label>
              <select id="accept_plans_payer_id"
                      name="payer_id"
                      required
                      class="block w-full h-11 rounded-lg border border-gray-200 bg-white px-3 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500"
                      aria-describedby="accept_plans_payer_help">
                <option value="">Select payer…</option>
                <% Array(@payer_options).each do |name, id| %>
                  <option value="<%= id %>"><%= name %></option>
                <% end %>
              </select>
              <p id="accept_plans_payer_help" class="mt-1 text-xs text-gray-500">
                Select a payer first; then choose one or more plans below.
              </p>
            </div>
            <%= form_with url: insurance_plans_search_tenant_org_accepted_plans_path, method: :get, id: "accept_plans_search_form", data: { turbo_frame: "insurance_plans_modal_list" }, class: "flex gap-2" do |f| %>
              <input type="hidden" name="payer_id" id="accept_plans_search_payer_id" value="">
              <label for="insurance_plans_search_q" class="sr-only">Search plans</label>
              <input type="search"
                     name="q"
                     id="insurance_plans_search_q"
                     value="<%= params[:q] %>"
                     placeholder="Search plans in this payer…"
                     class="block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                     autocomplete="off"
                     disabled>
            <% end %>
          </div>

          <% if pending_or_drafted_providers.any? && approved_providers.empty? %>
            <div class="mb-4 rounded-md border border-blue-100 bg-blue-50 p-3">
              <p class="text-xs text-blue-700">
                You have providers that are still being reviewed by HBS (draft or pending). You can accept plans now; payer enrollment will be completed after your providers are approved.
              </p>
            </div>
          <% elsif approved_providers.any? %>
            <div class="mb-4 rounded-md border border-green-100 bg-green-50 p-3">
              <p class="text-xs text-green-700">
                You have approved providers. Accepted plans will be ready for HBS to complete payer enrollment.
              </p>
            </div>
          <% end %>

          <%= form_with url: accept_plans_tenant_org_accepted_plans_path, method: :post, id: "accept_plans_form", data: { turbo: false } do %>
            <turbo-frame id="insurance_plans_modal_list" src="<%= insurance_plans_search_tenant_org_accepted_plans_path %>" loading="lazy">
              <div class="border border-gray-200 rounded-lg p-8 text-center text-gray-500 text-sm">Select a payer above to load plans.</div>
            </turbo-frame>

            <div class="mt-4">
              <label for="accept_plans_provider_id" class="block text-sm font-medium text-gray-700 mb-1">
                Provider for these plans
              </label>
              <select name="provider_id"
                      id="accept_plans_provider_id"
                      class="block w-full h-10 rounded-lg border border-gray-200 bg-white px-3 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500"
                      required>
                <option value="">Select provider…</option>
                <% all_providers.order(:first_name, :last_name).each do |provider| %>
                  <option value="<%= provider.id %>"><%= provider.full_name %></option>
                <% end %>
              </select>
              <p class="mt-1 text-xs text-gray-500">
                This provider will be used to initialize payer enrollment for the selected plans.
              </p>
            </div>

            <div class="mt-6 flex items-center justify-end gap-3">
              <button type="button" onclick="closeAcceptPlansModal()" class="rounded-md border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Cancel
              </button>
              <button type="submit" class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Accept plans
              </button>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  function openAcceptPlansModal() {
    var modal = document.getElementById('acceptPlansModal');
    var overlay = document.getElementById('acceptPlansModalOverlay');
    var content = document.getElementById('acceptPlansModalContent');
    if (!modal || !overlay || !content) return;
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    requestAnimationFrame(function() {
      overlay.classList.remove('opacity-0');
      overlay.classList.add('opacity-100');
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    });
  }
  function closeAcceptPlansModal() {
    var modal = document.getElementById('acceptPlansModal');
    var overlay = document.getElementById('acceptPlansModalOverlay');
    var content = document.getElementById('acceptPlansModalContent');
    if (!modal || !overlay || !content) return;
    overlay.classList.remove('opacity-100');
    overlay.classList.add('opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');
    setTimeout(function() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }, 300);
  }
  function updatePlansFrame() {
    var payerSelect = document.getElementById('accept_plans_payer_id');
    var searchForm = document.getElementById('accept_plans_search_form');
    var searchInput = document.getElementById('insurance_plans_search_q');
    var frame = document.getElementById('insurance_plans_modal_list');
    if (!payerSelect || !searchForm || !frame) return;
    var payerId = payerSelect.value || '';
    var q = (searchInput && searchInput.value) ? searchInput.value.trim() : '';
    var hiddenPayer = document.getElementById('accept_plans_search_payer_id');
    if (hiddenPayer) hiddenPayer.value = payerId;
    if (searchInput) searchInput.disabled = !payerId;
    var params = new URLSearchParams();
    if (payerId) params.set('payer_id', payerId);
    if (q) params.set('q', q);
    frame.src = searchForm.action + (params.toString() ? '?' + params.toString() : '');
  }

  document.addEventListener('DOMContentLoaded', function() {
    var acceptForm = document.getElementById('accept_plans_form');
    if (acceptForm) {
      acceptForm.addEventListener('change', function(e) {
        if (e.target.id === 'insurance_plans_select_all') {
          document.querySelectorAll('.insurance-plan-checkbox').forEach(function(cb) {
            cb.checked = e.target.checked;
          });
        }
        if (e.target.id === 'accept_plans_payer_id') {
          updatePlansFrame();
        }
      });

      acceptForm.addEventListener('submit', function(e) {
        var providerSelect = document.getElementById('accept_plans_provider_id');
        if (providerSelect && !providerSelect.value) {
          e.preventDefault();
          alert("Please select a provider before accepting plans.");
          providerSelect.focus();
          return;
        }
        var payerSelect = document.getElementById('accept_plans_payer_id');
        if (payerSelect && !payerSelect.value) {
          e.preventDefault();
          alert("Please select a payer first.");
          payerSelect.focus();
          return;
        }
        var checked = acceptForm.querySelectorAll('.insurance-plan-checkbox:checked');
        if (!checked.length) {
          e.preventDefault();
          alert("Please select at least one plan to accept.");
          return;
        }
      });
    }
    var searchInput = document.getElementById('insurance_plans_search_q');
    var searchForm = document.getElementById('accept_plans_search_form');
    if (searchInput && searchForm) {
      var searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() { updatePlansFrame(); }, 300);
      });
    }
    var payerSelect = document.getElementById('accept_plans_payer_id');
    if (payerSelect) {
      payerSelect.addEventListener('change', updatePlansFrame);
    }
  });
  document.addEventListener('turbo:load', function() {
    var openBtn = document.getElementById('open_accept_plans_modal');
    if (openBtn && !openBtn._acceptModalBound) {
      openBtn._acceptModalBound = true;
      openBtn.addEventListener('click', openAcceptPlansModal);
    }
    var acceptForm = document.getElementById('accept_plans_form');
    if (acceptForm && !acceptForm._selectAllBound) {
      acceptForm._selectAllBound = true;
      acceptForm.addEventListener('change', function(e) {
        if (e.target.id === 'insurance_plans_select_all') {
          document.querySelectorAll('.insurance-plan-checkbox').forEach(function(cb) {
            cb.checked = e.target.checked;
          });
        }
      });
    }
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var modal = document.getElementById('acceptPlansModal');
      if (modal && !modal.classList.contains('hidden')) closeAcceptPlansModal();
    }
  });
</script>
