<%= form_with(model: prescription, url: prescription.persisted? ? tenant_prescription_path(prescription) : tenant_prescriptions_path, method: prescription.persisted? ? :patch : :post, local: true, html: { class: "space-y-6", multipart: true }) do |f| %>
  <% if prescription.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(prescription.errors.count, "error") %> prohibited this prescription from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% prescription.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Basic Information -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Basic Information</h3>
      
      <div>
        <%= f.label :patient_id, "Patient", class: "block text-sm font-medium text-gray-700 mb-1" do %>
          Patient <span class="text-red-500">*</span>
        <% end %>
        <%= f.select :patient_id,
                     options_for_select(@patients.map { |p| [p.full_name, p.id] }, prescription.patient_id),
                     { prompt: "Select patient..." },
                     class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                     required: true %>
      </div>

      <div>
        <%= f.label :title, "Prescription Title", class: "block text-sm font-medium text-gray-700 mb-1" do %>
          Prescription Title <span class="text-red-500">*</span>
        <% end %>
        <%= f.text_field :title,
                         class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                         placeholder: "e.g., Physical Therapy, Medication, etc.",
                         required: true %>
      </div>

      <div>
        <%= f.label :date_written, "Date Written", class: "block text-sm font-medium text-gray-700 mb-1" do %>
          Date Written <span class="text-red-500">*</span>
        <% end %>
        <%= f.date_field :date_written,
                         value: prescription.date_written&.strftime("%Y-%m-%d") || Date.current.strftime("%Y-%m-%d"),
                         class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                         required: true %>
      </div>

      <div>
        <%= f.label :expires_on, "Expiration Date", class: "block text-sm font-medium text-gray-700 mb-1" do %>
          Expiration Date <span class="text-red-500">*</span>
        <% end %>

        <% selected_option = prescription.expiration_option.presence || "date" %>
        <div class="space-y-3">
          <label class="flex items-start gap-2 text-sm text-gray-700">
            <%= radio_button_tag "prescription[expiration_option]", "none", selected_option == "none", class: "mt-1" %>
            <span>No expiration specified (sets to 6 months after written date)</span>
          </label>

          <label class="flex items-start gap-2 text-sm text-gray-700">
            <%= radio_button_tag "prescription[expiration_option]", "duration", selected_option == "duration", class: "mt-1" %>
            <span>Duration specified</span>
          </label>
          <div class="ml-6 flex gap-2 items-center" data-expiration-duration>
            <%= number_field_tag "prescription[expiration_duration_value]",
                                 prescription.expiration_duration_value,
                                 min: 1,
                                 class: "w-24 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                                 placeholder: "12" %>
            <%= select_tag "prescription[expiration_duration_unit]",
                           options_for_select([["Days", "days"], ["Weeks", "weeks"], ["Months", "months"]], prescription.expiration_duration_unit || "weeks"),
                           class: "border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>

          <label class="flex items-start gap-2 text-sm text-gray-700">
            <%= radio_button_tag "prescription[expiration_option]", "date", selected_option == "date", class: "mt-1" %>
            <span>Date specified</span>
          </label>
          <div class="ml-6" data-expiration-date>
            <%= date_field_tag "prescription[expiration_date]",
                               prescription.expiration_date || prescription.expires_on&.strftime("%Y-%m-%d"),
                               class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          For NYSHIP massage prescriptions, expiration is capped at 6 months from the written date.
        </p>
      </div>
    </div>

    <!-- Prescription Details -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Prescription Details</h3>
      
      <div>
        <%= f.label :specialty_id, "Specialty", class: "block text-sm font-medium text-gray-700 mb-1" do %>
          Specialty <span class="text-red-500">*</span>
        <% end %>
        <%= f.select :specialty_id,
                     options_for_select(@specialties.map { |s| [s.name, s.id] }, prescription.specialty_id),
                     { prompt: "Select specialty..." },
                     class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                     required: true,
                     data: { all_specialties: @specialties.map { |s| { id: s.id, name: s.name } }.to_json } %>
      </div>

      <div>
        <%= f.label :procedure_code_id, "Procedure Code", class: "block text-sm font-medium text-gray-700 mb-1" do %>
          Procedure Code <span class="text-red-500">*</span>
        <% end %>
        <%= f.select :procedure_code_id,
                     [],
                     { prompt: "Select specialty first" },
                     class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                     required: true,
                     data: { current_procedure_id: prescription.procedure_code_id } %>
      </div>
    </div>
  </div>

  <!-- Diagnosis Codes -->
  <div class="space-y-4">
    <h3 class="text-lg font-medium text-gray-900">Diagnosis Codes</h3>

    <div class="relative diagnosis-code-search">
      <input type="text"
             id="prescriptionDiagnosisInput"
             class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm diagnosis-code-search-input focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="Type to search diagnosis codes..."
             autocomplete="off"
             onfocus="prescriptionShowDiagnosisDropdown()"
             oninput="prescriptionSearchDiagnosisCodes(this.value)">
      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <!-- Dropdown results -->
      <div id="prescription_diagnosis_results"
           class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-y-auto text-sm">
      </div>
    </div>

    <!-- Selected diagnosis codes display -->
    <div id="prescriptionSelectedDiagnosisCodes" class="mt-2 flex flex-wrap gap-2">
      <% if prescription.persisted? && prescription.diagnosis_codes.any? %>
        <% prescription.diagnosis_codes.each do |dc| %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800"
                data-code-id="<%= dc.id %>">
            <%= dc.code %> - <%= truncate(dc.description.to_s, length: 30) %>
            <button type="button"
                    onclick="prescriptionRemoveDiagnosisCode(<%= dc.id %>)"
                    class="ml-1 text-indigo-600 hover:text-indigo-800">×</button>
          </span>
        <% end %>
      <% end %>
    </div>

    <!-- Hidden inputs for submission -->
    <div id="prescriptionDiagnosisHiddenInputs">
      <% if prescription.persisted? %>
        <% Array(prescription.diagnosis_code_ids).each do |dc_id| %>
          <input type="hidden"
                 name="prescription[diagnosis_code_ids][]"
                 value="<%= dc_id %>"
                 id="prescriptionDiagnosisHidden<%= dc_id %>">
        <% end %>
      <% end %>
    </div>

    <p class="text-sm text-gray-500">
      Select diagnosis codes associated with this prescription.
    </p>
  </div>

  <!-- Documents -->
  <div class="space-y-4">
    <h3 class="text-lg font-medium text-gray-900">Documents</h3>
    
    <%= render 'shared/document_upload', 
        document_type: 'prescription_document',
        field_name: 'prescription[documents]',
        label: 'Attach Prescription Documents',
        hint: 'Upload prescription documents, images, or PDFs. Max 25MB per file.',
        multiple: true %>
    
    <% if prescription.persisted? && prescription.documents.attached? %>
      <div class="mt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Documents</h4>
        <div class="space-y-2">
          <% prescription.documents.each do |attachment| %>
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <div>
                  <p class="text-sm font-medium text-gray-900"><%= attachment.filename %></p>
                  <p class="text-xs text-gray-500"><%= number_to_human_size(attachment.byte_size) %> · <%= attachment.content_type %></p>
                </div>
              </div>
              <%= link_to "View", rails_blob_path(attachment, disposition: "inline"), target: "_blank", class: "text-sm text-blue-600 hover:text-blue-800" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="flex justify-between pt-4 border-t border-gray-100">
    <div>
      <% unless prescription.persisted? %>
        <button type="button" 
                onclick="clearPrescriptionForm()" 
                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
          Clear Form
        </button>
      <% end %>
    </div>
    <div class="flex gap-3">
      <%= link_to "Cancel", prescription.persisted? ? tenant_prescription_path(prescription) : tenant_prescriptions_path, class: "px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" %>
      <%= f.submit prescription.persisted? ? "Update Prescription" : "Create Prescription",
                   class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 cursor-pointer" %>
    </div>
  </div>
<% end %>

<script>
  // Diagnosis code search for prescription form
  (function() {
    // Reset global variable for new prescriptions
    var isNewForm = document.querySelector('form[action*="/prescriptions"][method="post"]') !== null;
    if (isNewForm) {
      window.prescriptionSelectedDiagnosisCodes = [];
    }
    
    if (window.prescriptionDiagnosisInitialized) return;
    window.prescriptionDiagnosisInitialized = true;

    window.prescriptionSelectedDiagnosisCodes = window.prescriptionSelectedDiagnosisCodes || [];
    let prescriptionDiagnosisTimeout = null;
    const searchUrl = "<%= search_tenant_diagnosis_codes_path %>";

    window.prescriptionShowDiagnosisDropdown = function() {
      const resultsDiv = document.getElementById("prescription_diagnosis_results");
      if (!resultsDiv) return;
      resultsDiv.classList.remove("hidden");
      if (resultsDiv.children.length === 0) {
        prescriptionSearchDiagnosisCodes("");
      }
    };

    window.prescriptionSearchDiagnosisCodes = function(query) {
      const resultsDiv = document.getElementById("prescription_diagnosis_results");
      if (!resultsDiv || !searchUrl) return;

      if (prescriptionDiagnosisTimeout) {
        clearTimeout(prescriptionDiagnosisTimeout);
      }

      prescriptionDiagnosisTimeout = setTimeout(function() {
        resultsDiv.classList.remove("hidden");
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">Searching...</div>';

        const url = searchUrl + "?q=" + encodeURIComponent(query || "");

        fetch(url, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || ""
          },
          credentials: "same-origin"
        })
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.success && data.results) {
              prescriptionDisplayDiagnosisResults(resultsDiv, data.results);
            } else {
              resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">No diagnosis codes found</div>';
            }
          })
          .catch(function(error) {
            console.error("Error searching diagnosis codes:", error);
            resultsDiv.innerHTML = '<div class="p-3 text-xs text-red-500 text-center">Error searching diagnosis codes</div>';
          });
      }, (query && query.length > 0) ? 250 : 0);
    };

    function prescriptionDisplayDiagnosisResults(resultsDiv, results) {
      if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">No diagnosis codes found</div>';
        return;
      }

      var selectedArray = Array.isArray(window.prescriptionSelectedDiagnosisCodes)
        ? window.prescriptionSelectedDiagnosisCodes
        : [];
      const selectedIds = selectedArray.map(function(s) { return s.id; });

      const html = results.map(function(result) {
        const code = result.code || "N/A";
        const description = result.description || "No description";
        const isSelected = selectedIds.indexOf(result.id) >= 0;

        return (
          '<div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors ' +
          (isSelected ? 'bg-indigo-100' : '') + '" ' +
          'onclick="prescriptionSelectDiagnosisCode(' + result.id + ', \'' + code.replace(/'/g, "\\'") + '\', \'' + description.replace(/'/g, "\\'") + '\')">' +
            '<div class="text-xs font-medium text-gray-900">' + code +
              (isSelected ? ' <span class="text-[10px] text-green-600">(Selected)</span>' : '') +
            '</div>' +
            '<div class="text-[11px] text-gray-500 mt-0.5">' + description + '</div>' +
          '</div>'
        );
      }).join("");

      resultsDiv.innerHTML =
        '<div class="p-2 border-b border-gray-200"><div class="text-[11px] text-gray-500">Select diagnosis codes</div></div>' + html;
    }

    window.prescriptionSelectDiagnosisCode = function(id, code, description) {
      if (!Array.isArray(window.prescriptionSelectedDiagnosisCodes)) {
        window.prescriptionSelectedDiagnosisCodes = [];
      }

      var selected = window.prescriptionSelectedDiagnosisCodes;
      var existingIndex = selected.findIndex(function(s) { return s.id === id; });

      if (existingIndex >= 0) {
        selected.splice(existingIndex, 1);
      } else {
        selected.push({ id: id, code: code, description: description });
      }

      prescriptionUpdateDiagnosisDisplay();

      var input = document.getElementById("prescriptionDiagnosisInput");
      if (input) input.value = "";

      var resultsDiv = document.getElementById("prescription_diagnosis_results");
      if (resultsDiv) resultsDiv.classList.add("hidden");
    };

    window.prescriptionRemoveDiagnosisCode = function(id) {
      if (!window.prescriptionSelectedDiagnosisCodes) return;
      var selected = window.prescriptionSelectedDiagnosisCodes;
      var index = selected.findIndex(function(s) { return s.id === id; });
      if (index >= 0) {
        selected.splice(index, 1);
        prescriptionUpdateDiagnosisDisplay();
      }
    };

    function prescriptionUpdateDiagnosisDisplay() {
      var container = document.getElementById("prescriptionSelectedDiagnosisCodes");
      var hiddenInputs = document.getElementById("prescriptionDiagnosisHiddenInputs");
      if (!container || !hiddenInputs) return;

      var selected = window.prescriptionSelectedDiagnosisCodes || [];

      if (selected.length === 0) {
        container.innerHTML = '<span class="text-xs text-gray-500">No diagnosis codes selected</span>';
      } else {
        container.innerHTML = selected.map(function(item) {
          var displayText = item.description
            ? (item.code + " - " + (item.description.length > 30 ? item.description.substring(0, 30) + "..." : item.description))
            : item.code;
          return (
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800" data-code-id="' + item.id + '">' +
              displayText +
              '<button type="button" onclick="prescriptionRemoveDiagnosisCode(' + item.id + ')" class="ml-1 text-indigo-600 hover:text-indigo-800">×</button>' +
            '</span>'
          );
        }).join(" ");
      }

      hiddenInputs.innerHTML = selected.map(function(item) {
        return '<input type="hidden" name="prescription[diagnosis_code_ids][]" value="' + item.id + '" id="prescriptionDiagnosisHidden' + item.id + '">';
      }).join("");
    }

    // Initialize from server-side selected codes on first load (only for persisted prescriptions)
    function initializePrescriptionDiagnosisCodes() {
      if (!Array.isArray(window.prescriptionSelectedDiagnosisCodes)) {
        window.prescriptionSelectedDiagnosisCodes = [];
      }
      
      // Only initialize if this is an edit form (prescription is persisted)
      var isEditForm = document.querySelector('form[action*="/prescriptions/"][method="patch"]') !== null;
      if (!isEditForm) {
        // Clear any persisted codes for new prescriptions
        window.prescriptionSelectedDiagnosisCodes = [];
        prescriptionUpdateDiagnosisDisplay();
        return;
      }
      
      var initialChips = document.querySelectorAll("#prescriptionSelectedDiagnosisCodes [data-code-id]");
      if (initialChips && initialChips.length > 0) {
        window.prescriptionSelectedDiagnosisCodes = Array.prototype.map.call(initialChips, function(el) {
          var id = parseInt(el.getAttribute("data-code-id"), 10);
          var text = el.textContent.trim().replace("×", "").trim();
          var code = text.split(" - ")[0];
          var description = text.split(" - ").slice(1).join(" - ");
          return { id: id, code: code, description: description };
        });
        prescriptionUpdateDiagnosisDisplay();
      } else {
        // Ensure empty for new prescriptions
        window.prescriptionSelectedDiagnosisCodes = [];
        prescriptionUpdateDiagnosisDisplay();
      }
    }

    // Clear form function
    window.clearPrescriptionForm = function() {
      // Clear diagnosis codes
      window.prescriptionSelectedDiagnosisCodes = [];
      prescriptionUpdateDiagnosisDisplay();
      
      // Clear form fields
      var form = document.querySelector('form[action*="/prescriptions"]');
      if (form) {
        // Reset patient select
        var patientSelect = document.getElementById("prescription_patient_id");
        if (patientSelect) patientSelect.value = "";
        
        // Reset title
        var titleInput = document.getElementById("prescription_title");
        if (titleInput) titleInput.value = "";
        
        // Reset date written to today
        var dateWritten = document.getElementById("prescription_date_written");
        if (dateWritten) dateWritten.value = new Date().toISOString().split('T')[0];
        
        // Reset expiration options
        var expirationRadios = document.querySelectorAll('input[name="prescription[expiration_option]"]');
        expirationRadios.forEach(function(radio) {
          if (radio.value === "date") radio.checked = true;
          else radio.checked = false;
        });
        
        // Reset expiration date
        var expirationDate = document.getElementById("prescription_expiration_date");
        if (expirationDate) expirationDate.value = "";
        
        // Reset expiration duration
        var durationValue = document.getElementById("prescription_expiration_duration_value");
        if (durationValue) durationValue.value = "";
        var durationUnit = document.getElementById("prescription_expiration_duration_unit");
        if (durationUnit) durationUnit.value = "weeks";
        
        // Reset specialty
        var specialtySelect = document.getElementById("prescription_specialty_id");
        if (specialtySelect) {
          specialtySelect.value = "";
          specialtySelect.innerHTML = '<option value="">Select specialty...</option>';
        }
        
        // Reset procedure code
        var procedureSelect = document.getElementById("prescription_procedure_code_id");
        if (procedureSelect) {
          procedureSelect.value = "";
          procedureSelect.innerHTML = '<option value="">Select specialty first</option>';
        }
        
        // Clear diagnosis input
        var diagnosisInput = document.getElementById("prescriptionDiagnosisInput");
        if (diagnosisInput) diagnosisInput.value = "";
      }
    };

    document.addEventListener("turbo:load", initializePrescriptionDiagnosisCodes);
    document.addEventListener("DOMContentLoaded", initializePrescriptionDiagnosisCodes);
    
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializePrescriptionDiagnosisCodes);
    } else {
      initializePrescriptionDiagnosisCodes();
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function(event) {
      var searchWrapper = document.querySelector(".diagnosis-code-search");
      if (searchWrapper && !searchWrapper.contains(event.target)) {
        var resultsDiv = document.getElementById("prescription_diagnosis_results");
        if (resultsDiv) resultsDiv.classList.add("hidden");
      }
    });
  })();
</script>

<script>
  document.addEventListener("turbo:load", function() {
    const radios = document.querySelectorAll("input[name='prescription[expiration_option]']");
    const durationBlock = document.querySelector("[data-expiration-duration]");
    const dateBlock = document.querySelector("[data-expiration-date]");
    if (!radios.length) return;

    function toggleExpirationInputs() {
      const selected = document.querySelector("input[name='prescription[expiration_option]']:checked")?.value;
      if (durationBlock) durationBlock.classList.toggle("hidden", selected !== "duration");
      if (dateBlock) dateBlock.classList.toggle("hidden", selected !== "date");
    }

    radios.forEach(function(radio) {
      radio.addEventListener("change", toggleExpirationInputs);
    });

    toggleExpirationInputs();
  });
</script>

<script>
  document.addEventListener("turbo:load", function() {
    const specialtySelect = document.getElementById("prescription_specialty_id");
    const procedureSelect = document.getElementById("prescription_procedure_code_id");
    const currentProcedureId = procedureSelect?.dataset?.currentProcedureId;
    const allSpecialties = specialtySelect?.dataset?.allSpecialties
      ? JSON.parse(specialtySelect.dataset.allSpecialties)
      : [];

    if (!specialtySelect || !procedureSelect) return;

    function resetProcedureCodes() {
      procedureSelect.innerHTML = '<option value="">Select specialty first</option>';
    }

    async function loadProcedureCodes(specialtyId, selectedId) {
      if (!specialtyId) {
        resetProcedureCodes();
        return;
      }
      const url = "<%= procedure_codes_for_specialty_tenant_prescriptions_path %>?specialty_id=" + encodeURIComponent(specialtyId);
      const response = await fetch(url, { headers: { "Accept": "application/json" } });
      const data = await response.json();

      resetProcedureCodes();
      if (!data.success) return;
      data.procedure_codes.forEach(function(pc) {
        const option = document.createElement("option");
        option.value = pc.id;
        option.textContent = pc.code + " - " + pc.description;
        if (selectedId && selectedId.toString() === pc.id.toString()) {
          option.selected = true;
        }
        procedureSelect.appendChild(option);
      });
    }

    specialtySelect.addEventListener("change", function() {
      loadProcedureCodes(specialtySelect.value, null);
    });

    if (specialtySelect.value) {
      loadProcedureCodes(specialtySelect.value, currentProcedureId);
    } else {
      resetProcedureCodes();
    }
  });
</script>
