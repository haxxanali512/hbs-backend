<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
  <% if @fee_schedule_item.errors.any? %>
    <div class="mb-6 bg-red-50 border border-red-200 text-red-800 rounded-md p-4">
      <div class="font-semibold mb-2"><%= pluralize(@fee_schedule_item.errors.count, "error") %> prohibited this item from being saved:</div>
      <ul class="list-disc ml-6 text-sm">
        <% @fee_schedule_item.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with(model: @fee_schedule_item, url: (@fee_schedule_item.persisted? ? tenant_fee_schedule_fee_schedule_item_path(@fee_schedule, @fee_schedule_item) : tenant_fee_schedule_fee_schedule_items_path(@fee_schedule)), local: true, class: "space-y-6") do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= f.label :procedure_code_id, "Procedure Code", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :procedure_code_id, 
            options_from_collection_for_select(@procedure_codes, :id, :code, @fee_schedule_item.procedure_code_id),
            { prompt: "Select Procedure Code" },
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
              id: "procedure_code_select",
              data: { existing_items: @existing_items_by_code.to_json } } %>
        <% if @existing_items_by_code.present? %>
          <div id="existing_item_warning" class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-800 hidden">
            <p class="font-medium">⚠️ Warning: An active fee schedule item already exists for this procedure code.</p>
            <p class="mt-1">Only one active item is allowed per procedure code per organization. Please edit the existing item or deactivate it first.</p>
          </div>
        <% end %>
      </div>

      <div>
        <%= f.label :pricing_rule, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :pricing_rule, 
            [["Per Unit", "per_unit"], ["Per Minute", "per_minute"], ["Per Hour", "per_hour"], ["Per Visit", "per_visit"], ["Per Procedure", "per_procedure"]],
            { selected: @fee_schedule_item.pricing_rule || 'per_unit' },
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
      </div>
    </div>

    <div>
      <%= f.label :unit_price, "Unit Price", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <span class="text-gray-500 sm:text-sm">$</span>
        </div>
        <%= f.number_field :unit_price, 
            step: 0.01,
            min: 0,
            class: "w-full pl-7 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
            placeholder: "0.00" %>
      </div>
    </div>

    <% if @fee_schedule_item.persisted? %>
      <div>
        <%= f.label :active, class: "flex items-center" do %>
          <%= f.check_box :active, class: "mr-2" %>
          <span class="text-sm font-medium text-gray-700">Active</span>
        <% end %>
        <p class="mt-1 text-sm text-gray-500">Inactive items are hidden from pricing calculations</p>
      </div>
    <% end %>

    <div class="flex justify-end space-x-3">
      <%= link_to "Cancel", 
          (@fee_schedule_item.persisted? ? tenant_fee_schedule_fee_schedule_item_path(@fee_schedule, @fee_schedule_item) : tenant_fee_schedule_fee_schedule_items_path(@fee_schedule)),
          class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors" %>
      <%= f.submit (@fee_schedule_item.persisted? ? "Update Item" : "Create Item"),
          class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>
    </div>
  <% end %>
</div>

<script>
  (function() {
    const procedureCodeSelect = document.getElementById('procedure_code_select');
    const warningDiv = document.getElementById('existing_item_warning');
    
    if (procedureCodeSelect && warningDiv) {
      const existingItems = JSON.parse(procedureCodeSelect.dataset.existingItems || '{}');
      
      procedureCodeSelect.addEventListener('change', function() {
        const selectedCodeId = this.value;
        if (selectedCodeId && existingItems[selectedCodeId]) {
          warningDiv.classList.remove('hidden');
        } else {
          warningDiv.classList.add('hidden');
        }
      });
      
      // Show warning on page load if a code is pre-selected
      if (procedureCodeSelect.value && existingItems[procedureCodeSelect.value]) {
        warningDiv.classList.remove('hidden');
      }
    }
  })();
</script>
