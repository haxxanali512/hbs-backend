<%= form_with(model: encounter,
             url: encounter.persisted? ? tenant_encounter_path(encounter) : tenant_encounters_path,
             method: encounter.persisted? ? :patch : :post,
             data: { turbo_stream: true },
             id: "encounter_workflow_form",
             class: "space-y-6 p-6") do |f| %>
  <% if encounter.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(encounter.errors.count, "error") %> prohibited this encounter from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% encounter.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Patient -->
    <div class="space-y-1">
      <%= f.label :patient_id, class: "block text-sm font-medium text-gray-700" do %>
        Patient <span class="text-red-500">*</span>
      <% end %>
      <%= f.select :patient_id,
                   options_for_select(patients.map { |p| [p.full_name, p.id] }, encounter.patient_id),
                   { prompt: "Select patient..." },
                   class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                   required: true %>
    </div>

    <!-- Provider -->
    <div class="space-y-1">
      <%= f.label :provider_id, class: "block text-sm font-medium text-gray-700" do %>
        Provider <span class="text-red-500">*</span>
      <% end %>
      <%= f.select :provider_id,
                   options_for_select(providers.map { |p| [p.full_name, p.id] }, encounter.provider_id),
                   { prompt: "Select provider..." },
                   class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                   required: true,
                   data: { current_specialty_id: encounter.specialty_id } %>
    </div>

    <!-- Specialty -->
    <div class="space-y-1">
      <%= f.label :specialty_id, class: "block text-sm font-medium text-gray-700" do %>
        Specialty <span class="text-red-500">*</span>
      <% end %>
      <%= f.select :specialty_id,
                   [],
                   { prompt: "Select provider first" },
                   class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                   required: true %>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Template (curated by HBS) -->
    <div class="space-y-1">
      <%= f.label :encounter_template_id, "Template (Optional)", class: "block text-sm font-medium text-gray-700" %>
      <%= f.select :encounter_template_id,
                   [],
                   { prompt: "Select template..." },
                   class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                   data: { current_template_id: encounter.encounter_template_id } %>
    </div>

    <!-- Date of Service -->
    <div class="space-y-1">
      <%= f.label :date_of_service, class: "block text-sm font-medium text-gray-700" do %>
        Date of Service <span class="text-red-500">*</span>
      <% end %>
      <%= f.date_field :date_of_service,
                       value: encounter.date_of_service&.strftime("%Y-%m-%d") || Date.current.strftime("%Y-%m-%d"),
                       class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",
                       required: true %>
    </div>

    <!-- Place of Service -->
    <div class="space-y-1">
      <%= f.label :place_of_service_code, "Place of Service", class: "block text-sm font-medium text-gray-700" %>
      <% pos_selected = encounter.place_of_service_code.presence || encounter.claim&.place_of_service_code || "11" %>
      <%= f.select :place_of_service_code,
                   options_for_select(
                     [
                       ["11 - Office", 11],
                       ["12 - Patient's Home", 12],
                       ["02 - Telehealth / Virtual", 2]
                     ],
                     pos_selected.to_i
                   ),
                   {},
                   class: "w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>
  </div>

  <script>
    document.addEventListener("turbo:load", function() {
      if (window.encounterTemplatesInitialized) return;
      window.encounterTemplatesInitialized = true;

      const providerSelect = document.getElementById("encounter_provider_id");
      const specialtySelect = document.getElementById("encounter_specialty_id");
      const templateSelect = document.getElementById("encounter_encounter_template_id");
      const currentSpecialtyId = providerSelect?.dataset?.currentSpecialtyId;
      const currentTemplateId = templateSelect?.dataset?.currentTemplateId;
      const templatesUrl = "<%= templates_for_specialty_tenant_encounters_path %>";
      let templatesIndex = {};
      let templatesRequestId = 0;

      if (!providerSelect || !specialtySelect) return;

      function resetSpecialties() {
        specialtySelect.innerHTML = '<option value="">Select provider first</option>';
      }

      function resetTemplates() {
        if (!templateSelect) return;
        templateSelect.innerHTML = '<option value="">Select template...</option>';
        templatesIndex = {};
      }

      function clearProcedureSelection() {
        window.workflowSelectedProcedureCodes = [];
        if (window.workflowUpdateProcedureDisplay) {
          window.workflowUpdateProcedureDisplay();
        }
      }

      async function loadSpecialties(providerId, selectedId) {
        if (!providerId) {
          resetSpecialties();
          resetTemplates();
          clearProcedureSelection();
          return;
        }

        const url = "<%= specialties_for_provider_tenant_encounters_path %>?provider_id=" + encodeURIComponent(providerId);
        const response = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await response.json();

        resetSpecialties();
        if (!data.success) return;

        data.specialties.forEach(function(spec) {
          const option = document.createElement("option");
          option.value = spec.id;
          option.textContent = spec.name;
          if (selectedId && selectedId.toString() === spec.id.toString()) {
            option.selected = true;
          }
          specialtySelect.appendChild(option);
        });
      }

      async function loadTemplates(specialtyId, selectedId) {
        if (!templateSelect) return;
        resetTemplates();
        templatesRequestId += 1;
        const requestId = templatesRequestId;
        const url = specialtyId
          ? (templatesUrl + "?specialty_id=" + encodeURIComponent(specialtyId))
          : templatesUrl;
        const response = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await response.json();
        if (!data.success) return;
        if (requestId !== templatesRequestId) return;

        data.templates.forEach(function(template) {
          templatesIndex[template.id] = template;
          const option = document.createElement("option");
          option.value = template.id;
          option.textContent = template.specialty_name
            ? (template.name + " (" + template.specialty_name + ")")
            : template.name;
          if (selectedId && selectedId.toString() === template.id.toString()) {
            option.selected = true;
          }
          templateSelect.appendChild(option);
        });

        if (selectedId && templateSelect.value) {
          applyTemplate(templateSelect.value);
        }
      }

      function applyTemplate(templateId) {
        const template = templatesIndex[templateId];
        if (!template) return;

        window.workflowSelectedProcedureCodes = (template.lines || []).map(function(line) {
          return {
            id: line.procedure_code_id,
            code: line.code,
            description: line.description,
            units: line.units,
            modifier: (line.modifiers && line.modifiers.length > 0) ? line.modifiers[0] : ""
          };
        });
        if (window.workflowUpdateProcedureDisplay) {
          window.workflowUpdateProcedureDisplay();
        }

        // Default primary procedure to the first template line
        const primarySelect = document.getElementById("workflowPrimaryProcedure");
        if (primarySelect) {
          if (window.workflowSelectedProcedureCodes.length > 0) {
            primarySelect.value = window.workflowSelectedProcedureCodes[0].id;
          } else {
            primarySelect.value = "";
          }
        }
      }

      providerSelect.addEventListener("change", async function() {
        await loadSpecialties(providerSelect.value, null);
        if (templateSelect) templateSelect.value = "";
        await loadTemplates(specialtySelect.value, null);
      });

      specialtySelect.addEventListener("change", function() {
        loadTemplates(specialtySelect.value, null);
        if (templateSelect) templateSelect.value = "";
        clearProcedureSelection();
      });

      if (templateSelect) {
        templateSelect.addEventListener("change", function() {
          if (templateSelect.value) {
            applyTemplate(templateSelect.value);
          } else {
            clearProcedureSelection();
          }
        });
      }

      async function initializeTemplates() {
        if (providerSelect.value) {
          await loadSpecialties(providerSelect.value, currentSpecialtyId);
          await loadTemplates(specialtySelect.value, currentTemplateId);
        } else {
          resetSpecialties();
          await loadTemplates(null, currentTemplateId);
        }
      }

      initializeTemplates();
    });
  </script>

  <script>
    window.workflowInitialServiceLines = <%= raw(
      encounter.encounter_procedure_items.includes(:procedure_code).map do |item|
        {
          id: item.procedure_code_id,
          code: item.procedure_code.code,
          description: item.procedure_code.description,
          units: item.units,
          modifier: item.modifiers&.first
        }
      end.to_json
    ) %>;
  </script>

  <!-- Procedure Codes with search -->
  <div class="space-y-4">
    <h3 class="text-sm font-medium text-gray-900">Procedure Codes <span class="text-red-500">*</span></h3>

    <div class="relative procedure-code-search">
      <input type="text"
             id="workflowProcedureInput"
             class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="Type to search procedure codes..."
             autocomplete="off"
             onfocus="workflowShowProcedureDropdown()"
             oninput="workflowSearchProcedureCodes(this.value)">
      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <!-- Dropdown results -->
      <div id="procedure_workflow_results"
           class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-y-auto text-sm">
      </div>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Procedure Code</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modifier</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="workflowServiceLinesBody" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">No procedure codes selected.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="text-xs text-gray-500">
      Select procedure codes. At least one is required.
    </p>

    <!-- Primary Procedure Code -->
    <div class="space-y-1">
      <label class="block text-sm font-medium text-gray-700">Primary Procedure Code</label>
      <select name="encounter[primary_procedure_code_id]"
              id="workflowPrimaryProcedure"
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select primary procedure (optional)...</option>
      </select>
      <p class="text-xs text-gray-500">
        The primary procedure is optional and will be used for pricing rules if specified.
      </p>
    </div>
  </div>

  <!-- Diagnosis Codes with search (up to 4) -->
  <div class="space-y-2">
    <h3 class="text-sm font-medium text-gray-900">Diagnosis Codes <span class="text-red-500">*</span></h3>

    <div class="relative diagnosis-code-search">
      <input type="text"
             id="workflowDiagnosisInput"
             class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm diagnosis-code-search-input focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="Type to search diagnosis codes..."
             autocomplete="off"
             onfocus="workflowShowDiagnosisDropdown()"
             oninput="workflowSearchDiagnosisCodes(this.value)">
      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <!-- Dropdown results -->
      <div id="diagnosis_workflow_results"
           class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-64 overflow-y-auto text-sm">
      </div>
    </div>

    <!-- Selected diagnosis codes display -->
    <div id="workflowSelectedDiagnosisCodes" class="mt-2 flex flex-wrap gap-2">
      <% if encounter.diagnosis_codes.any? %>
        <% encounter.diagnosis_codes.limit(4).each do |dc| %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800"
                data-code-id="<%= dc.id %>">
            <%= dc.code %> - <%= truncate(dc.description.to_s, length: 30) %>
            <button type="button"
                    onclick="workflowRemoveDiagnosisCode(<%= dc.id %>)"
                    class="ml-1 text-indigo-600 hover:text-indigo-800">×</button>
          </span>
        <% end %>
      <% end %>
    </div>

    <!-- Hidden inputs for submission -->
    <div id="workflowDiagnosisHiddenInputs">
      <% Array(encounter.try(:diagnosis_code_ids)).first(4).each do |dc_id| %>
        <input type="hidden"
               name="encounter[diagnosis_code_ids][]"
               value="<%= dc_id %>"
               id="workflowDiagnosisHidden<%= dc_id %>">
      <% end %>
    </div>

    <p class="text-xs text-gray-500">
      Select up to 4 diagnosis codes. At least one is required.
    </p>
  </div>

  <div class="flex justify-end pt-4 border-t border-gray-100 space-x-3">
    <button type="button"
            id="clear_workflow_form_button"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
      Clear Form
    </button>
    <%= f.submit encounter.persisted? ? "Update Encounter" : "Save for Submission",
                 class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 cursor-pointer" %>
  </div>
<% end %>

<script>
  function resetEncounterWorkflowForm() {
    const form = document.getElementById("encounter_workflow_form");
    if (form) form.reset();

    // Clear diagnosis codes UI/hidden inputs
    window.workflowSelectedDiagnosisCodes = [];
    const dxContainer = document.getElementById("workflowSelectedDiagnosisCodes");
    const dxHidden = document.getElementById("workflowDiagnosisHiddenInputs");
    if (dxContainer) {
      dxContainer.innerHTML = '<span class="text-xs text-gray-500">No diagnosis codes selected</span>';
    }
    if (dxHidden) dxHidden.innerHTML = "";

    // Clear procedure codes UI/hidden inputs
    window.workflowSelectedProcedureCodes = [];
    const procContainer = document.getElementById("workflowServiceLinesBody");
    if (procContainer) {
      procContainer.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">No procedure codes selected.</td></tr>';
    }

    // Reset primary procedure options
    const primarySelect = document.getElementById("workflowPrimaryProcedure");
    if (primarySelect) {
      primarySelect.innerHTML = '<option value="">Select primary procedure (optional)...</option>';
    }

    // Hide dropdown results
    const dxResults = document.getElementById("diagnosis_workflow_results");
    const procResults = document.getElementById("procedure_workflow_results");
    if (dxResults) dxResults.classList.add("hidden");
    if (procResults) procResults.classList.add("hidden");
  }

  // Diagnosis code search for workflow (up to 4)
  (function() {
    if (window.workflowDiagnosisInitialized) return;
    window.workflowDiagnosisInitialized = true;

    const MAX_DIAGNOSIS_CODES = 4;
    window.workflowSelectedDiagnosisCodes = window.workflowSelectedDiagnosisCodes || [];
    let workflowDiagnosisTimeout = null;
    const searchUrl = "<%= search_tenant_diagnosis_codes_path %>";

    window.workflowShowDiagnosisDropdown = function() {
      const resultsDiv = document.getElementById("diagnosis_workflow_results");
      if (!resultsDiv) return;
      resultsDiv.classList.remove("hidden");
      if (resultsDiv.children.length === 0) {
        workflowSearchDiagnosisCodes("");
      }
    };

    window.workflowSearchDiagnosisCodes = function(query) {
      const resultsDiv = document.getElementById("diagnosis_workflow_results");
      if (!resultsDiv || !searchUrl) return;

      if (workflowDiagnosisTimeout) {
        clearTimeout(workflowDiagnosisTimeout);
      }

      workflowDiagnosisTimeout = setTimeout(function() {
        resultsDiv.classList.remove("hidden");
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">Searching...</div>';

        const url = searchUrl + "?q=" + encodeURIComponent(query || "");

        fetch(url, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || ""
          },
          credentials: "same-origin"
        })
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.success && data.results) {
              workflowDisplayDiagnosisResults(resultsDiv, data.results);
            } else {
              resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">No diagnosis codes found</div>';
            }
          })
          .catch(function(error) {
            console.error("Error searching diagnosis codes:", error);
            resultsDiv.innerHTML = '<div class="p-3 text-xs text-red-500 text-center">Error searching diagnosis codes</div>';
          });
      }, (query && query.length > 0) ? 250 : 0);
    };

    function workflowDisplayDiagnosisResults(resultsDiv, results) {
      if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">No diagnosis codes found</div>';
        return;
      }

      var selectedArray = Array.isArray(window.workflowSelectedDiagnosisCodes)
        ? window.workflowSelectedDiagnosisCodes
        : [];
      const selectedIds = selectedArray.map(function(s) { return s.id; });

      const html = results.map(function(result) {
        const code = result.code || "N/A";
        const description = result.description || "No description";
        const isSelected = selectedIds.indexOf(result.id) >= 0;

        return (
          '<div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors ' +
          (isSelected ? 'bg-indigo-100' : '') + '" ' +
          'onclick="workflowSelectDiagnosisCode(' + result.id + ', \'' + code.replace(/'/g, "\\'") + '\', \'' + description.replace(/'/g, "\\'") + '\')">' +
            '<div class="text-xs font-medium text-gray-900">' + code +
              (isSelected ? ' <span class=\"text-[10px] text-green-600\">(Selected)</span>' : '') +
            '</div>' +
            '<div class="text-[11px] text-gray-500 mt-0.5">' + description + '</div>' +
          '</div>'
        );
      }).join("");

      resultsDiv.innerHTML =
        '<div class="p-2 border-b border-gray-200"><div class="text-[11px] text-gray-500">Select diagnosis codes (up to ' +
        MAX_DIAGNOSIS_CODES + ')</div></div>' + html;
    }

    window.workflowSelectDiagnosisCode = function(id, code, description) {
      if (!Array.isArray(window.workflowSelectedDiagnosisCodes)) {
        window.workflowSelectedDiagnosisCodes = [];
      }

      var selected = window.workflowSelectedDiagnosisCodes;
      var existingIndex = selected.findIndex(function(s) { return s.id === id; });

      if (existingIndex >= 0) {
        selected.splice(existingIndex, 1);
      } else {
        if (selected.length >= MAX_DIAGNOSIS_CODES) {
          alert("You can only select up to " + MAX_DIAGNOSIS_CODES + " diagnosis codes.");
          return;
        }
        selected.push({ id: id, code: code, description: description });
      }

      workflowUpdateDiagnosisDisplay();

      var input = document.getElementById("workflowDiagnosisInput");
      if (input) input.value = "";

      var resultsDiv = document.getElementById("diagnosis_workflow_results");
      if (resultsDiv) resultsDiv.classList.add("hidden");
    };

    window.workflowRemoveDiagnosisCode = function(id) {
      if (!window.workflowSelectedDiagnosisCodes) return;
      var selected = window.workflowSelectedDiagnosisCodes;
      var index = selected.findIndex(function(s) { return s.id === id; });
      if (index >= 0) {
        selected.splice(index, 1);
        workflowUpdateDiagnosisDisplay();
      }
    };

    function workflowUpdateDiagnosisDisplay() {
      var container = document.getElementById("workflowSelectedDiagnosisCodes");
      var hiddenInputs = document.getElementById("workflowDiagnosisHiddenInputs");
      if (!container || !hiddenInputs) return;

      var selected = window.workflowSelectedDiagnosisCodes || [];

      if (selected.length === 0) {
        container.innerHTML = '<span class="text-xs text-gray-500">No diagnosis codes selected</span>';
      } else {
        container.innerHTML = selected.map(function(item) {
          var displayText = item.description
            ? (item.code + " - " + (item.description.length > 30 ? item.description.substring(0, 30) + "..." : item.description))
            : item.code;
          return (
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800" data-code-id="' + item.id + '">' +
              displayText +
              '<button type="button" onclick="workflowRemoveDiagnosisCode(' + item.id + ')" class="ml-1 text-indigo-600 hover:text-indigo-800">×</button>' +
            '</span>'
          );
        }).join(" ");
      }

      hiddenInputs.innerHTML = selected.map(function(item) {
        return '<input type="hidden" name="encounter[diagnosis_code_ids][]" value="' + item.id + '" id="workflowDiagnosisHidden' + item.id + '">';
      }).join("");
    }

    // Initialize from server-side selected codes on first load
    function initializeDiagnosisCodes() {
      if (!Array.isArray(window.workflowSelectedDiagnosisCodes)) {
        window.workflowSelectedDiagnosisCodes = [];
      }
      
      var initialChips = document.querySelectorAll("#workflowSelectedDiagnosisCodes [data-code-id]");
      if (initialChips && initialChips.length > 0) {
        window.workflowSelectedDiagnosisCodes = Array.prototype.map.call(initialChips, function(el) {
          var id = parseInt(el.getAttribute("data-code-id"), 10);
          var text = el.textContent.trim().replace("×", "").trim();
          var code = text.split(" - ")[0];
          var description = text.split(" - ").slice(1).join(" - ");
          return { id: id, code: code, description: description };
        });
        workflowUpdateDiagnosisDisplay();
      }
    }

    document.addEventListener("turbo:load", initializeDiagnosisCodes);
    document.addEventListener("DOMContentLoaded", initializeDiagnosisCodes);
    
    // Also initialize immediately if DOM is already loaded
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeDiagnosisCodes);
    } else {
      initializeDiagnosisCodes();
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function(event) {
      var searchWrapper = document.querySelector(".diagnosis-code-search");
      if (searchWrapper && !searchWrapper.contains(event.target)) {
        var resultsDiv = document.getElementById("diagnosis_workflow_results");
        if (resultsDiv) resultsDiv.classList.add("hidden");
      }
    });
  })();

  // Clear form button + clear on navigation
  (function() {
    function bindClearHandlers() {
      const clearBtn = document.getElementById("clear_workflow_form_button");
      if (clearBtn) {
        clearBtn.addEventListener("click", function() {
          resetEncounterWorkflowForm();
        });
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindClearHandlers);
    } else {
      bindClearHandlers();
    }
    document.addEventListener("turbo:load", bindClearHandlers);

    // Clear form when navigating away
    document.addEventListener("turbo:before-cache", function() {
      resetEncounterWorkflowForm();
    });
    window.addEventListener("pagehide", function() {
      resetEncounterWorkflowForm();
    });
  })();

  window.workflowModifierOptions = <%= raw([
    { code: "GP", label: "GP" },
    { code: "GT", label: "GT" },
    { code: "95", label: "95" },
    { code: "25", label: "25" },
    { code: "59", label: "59" }
  ].to_json) %>;

  // Procedure code search for workflow (no hard limit)
  (function() {
    if (window.workflowProcedureInitialized) return;
    window.workflowProcedureInitialized = true;

    const MAX_PROCEDURE_CODES = null;
    window.workflowSelectedProcedureCodes = window.workflowSelectedProcedureCodes || [];
    let workflowProcedureTimeout = null;
    const procedureSearchUrl = "<%= search_tenant_procedure_codes_path %>";

    window.workflowShowProcedureDropdown = function() {
      const resultsDiv = document.getElementById("procedure_workflow_results");
      const specialtyId = document.getElementById("encounter_specialty_id")?.value;
      if (!resultsDiv) return;
      if (!specialtyId) {
        resultsDiv.classList.remove("hidden");
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">Select a specialty first</div>';
        return;
      }
      resultsDiv.classList.remove("hidden");
      if (resultsDiv.children.length === 0) {
        workflowSearchProcedureCodes("");
      }
    };

    window.workflowSearchProcedureCodes = function(query) {
      const resultsDiv = document.getElementById("procedure_workflow_results");
      if (!resultsDiv || !procedureSearchUrl) return;

      if (workflowProcedureTimeout) {
        clearTimeout(workflowProcedureTimeout);
      }

      workflowProcedureTimeout = setTimeout(function() {
        resultsDiv.classList.remove("hidden");
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">Searching...</div>';

        const specialtyId = document.getElementById("encounter_specialty_id")?.value;
        const url = procedureSearchUrl +
          "?q=" + encodeURIComponent(query || "") +
          (specialtyId ? ("&specialty_id=" + encodeURIComponent(specialtyId)) : "");

        fetch(url, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content || ""
          },
          credentials: "same-origin"
        })
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.success && data.results) {
              workflowDisplayProcedureResults(resultsDiv, data.results);
            } else {
              resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">No procedure codes found</div>';
            }
          })
          .catch(function(error) {
            console.error("Error searching procedure codes:", error);
            resultsDiv.innerHTML = '<div class="p-3 text-xs text-red-500 text-center">Error searching procedure codes</div>';
          });
      }, (query && query.length > 0) ? 250 : 0);
    };

    function workflowDisplayProcedureResults(resultsDiv, results) {
      if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<div class="p-3 text-xs text-gray-500 text-center">No procedure codes found</div>';
        return;
      }

      if (!Array.isArray(window.workflowSelectedProcedureCodes)) {
        window.workflowSelectedProcedureCodes = [];
      }
      const selectedIds = window.workflowSelectedProcedureCodes.map(function(s) { return s.id; });

      const html = results.map(function(result) {
        const code = result.code || "N/A";
        const description = result.description || "No description";
        const isSelected = selectedIds.indexOf(result.id) >= 0;

        return (
          '<div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors ' +
          (isSelected ? 'bg-blue-100' : '') + '" ' +
          'onclick="workflowSelectProcedureCode(' + result.id + ', \'' + code.replace(/'/g, "\\'") + '\', \'' + description.replace(/'/g, "\\'") + '\')">' +
            '<div class="text-xs font-medium text-gray-900">' + code +
              (isSelected ? ' <span class=\"text-[10px] text-green-600\">(Selected)</span>' : '') +
            '</div>' +
            '<div class="text-[11px] text-gray-500 mt-0.5">' + description + '</div>' +
          '</div>'
        );
      }).join("");

      resultsDiv.innerHTML =
        '<div class="p-2 border-b border-gray-200"><div class="text-[11px] text-gray-500">Select procedure codes</div></div>' + html;
    }

    window.workflowSelectProcedureCode = function(id, code, description) {
      if (!Array.isArray(window.workflowSelectedProcedureCodes)) {
        window.workflowSelectedProcedureCodes = [];
      }

      var selected = window.workflowSelectedProcedureCodes;
      var existingIndex = selected.findIndex(function(s) { return s.id === id; });

      if (existingIndex >= 0) {
        selected.splice(existingIndex, 1);
      } else {
      if (MAX_PROCEDURE_CODES && selected.length >= MAX_PROCEDURE_CODES) {
        alert("You can only select up to " + MAX_PROCEDURE_CODES + " procedure codes.");
        return;
      }
        selected.push({ id: id, code: code, description: description });
      }

      workflowUpdateProcedureDisplay();

      var input = document.getElementById("workflowProcedureInput");
      if (input) input.value = "";

      var resultsDiv = document.getElementById("procedure_workflow_results");
      if (resultsDiv) resultsDiv.classList.add("hidden");
    };

    window.workflowRemoveProcedureCode = function(id) {
      if (!Array.isArray(window.workflowSelectedProcedureCodes)) {
        window.workflowSelectedProcedureCodes = [];
      }
      var selected = window.workflowSelectedProcedureCodes;
      var index = selected.findIndex(function(s) { return s.id === id; });
      if (index >= 0) {
        selected.splice(index, 1);
        workflowUpdateProcedureDisplay();
      }
    };

    function workflowUpdateProcedureDisplay() {
      var container = document.getElementById("workflowServiceLinesBody");
      var primarySelect = document.getElementById("workflowPrimaryProcedure");
      if (!container || !primarySelect) return;

      if (!Array.isArray(window.workflowSelectedProcedureCodes)) {
        window.workflowSelectedProcedureCodes = [];
      }
      var selected = window.workflowSelectedProcedureCodes;

      if (selected.length === 0) {
        container.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">No procedure codes selected.</td></tr>';
      } else {
        var modifierOptions = window.workflowModifierOptions || [];
        container.innerHTML = selected.map(function(item) {
          var displayText = item.description
            ? (item.code + " - " + (item.description.length > 30 ? item.description.substring(0, 30) + "..." : item.description))
            : item.code;
          var modifierSelect = '<select name="encounter[procedure_modifiers][' + item.id + ']" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">' +
            '<option value="">None</option>' +
            modifierOptions.map(function(opt) {
              var selectedAttr = item.modifier && item.modifier.toString() === opt.code.toString() ? ' selected' : '';
              return '<option value="' + opt.code + '"' + selectedAttr + '>' + opt.label + '</option>';
            }).join("") +
            '</select>';
          return (
            '<tr data-procedure-id="' + item.id + '">' +
              '<td class="px-4 py-2 text-sm text-gray-900">' +
                displayText +
                '<input type="hidden" name="encounter[procedure_code_ids][]" value="' + item.id + '">' +
              '</td>' +
              '<td class="px-4 py-2">' + modifierSelect + '</td>' +
              '<td class="px-4 py-2">' +
                '<input type="number" name="encounter[procedure_units][' + item.id + ']" min="1" step="1" value="' + (item.units || 1) + '" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm" />' +
              '</td>' +
              '<td class="px-4 py-2 text-right">' +
                '<button type="button" onclick="workflowRemoveProcedureCode(' + item.id + ')" class="text-red-600 hover:text-red-800 text-sm">Remove</button>' +
              '</td>' +
            '</tr>'
          );
        }).join("");
      }

      // Rebuild primary procedure select
      primarySelect.innerHTML = '<option value="">Select primary procedure (optional)...</option>';
      selected.forEach(function(item) {
        var opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.code;
        primarySelect.appendChild(opt);
      });
      
      // If there's only one procedure code, auto-select it as primary
      if (selected.length === 1 && !primarySelect.value) {
        primarySelect.value = selected[0].id;
      }
    }
    window.workflowUpdateProcedureDisplay = workflowUpdateProcedureDisplay;

    // Initialize procedure codes from server-side on first load
    function initializeProcedureCodes() {
      if (!Array.isArray(window.workflowSelectedProcedureCodes)) {
        window.workflowSelectedProcedureCodes = [];
      }

      if (window.workflowInitialServiceLines && window.workflowInitialServiceLines.length > 0) {
        window.workflowSelectedProcedureCodes = window.workflowInitialServiceLines;
        workflowUpdateProcedureDisplay();
      }
    }

    document.addEventListener("turbo:load", initializeProcedureCodes);
    document.addEventListener("DOMContentLoaded", initializeProcedureCodes);
    
    // Also initialize immediately if DOM is already loaded
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeProcedureCodes);
    } else {
      initializeProcedureCodes();
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function(event) {
      var searchWrapper = document.querySelector(".procedure-code-search");
      if (searchWrapper && !searchWrapper.contains(event.target)) {
        var resultsDiv = document.getElementById("procedure_workflow_results");
        if (resultsDiv) resultsDiv.classList.add("hidden");
      }
    });
  })();
</script>


