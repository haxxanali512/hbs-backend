<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <% if show_queued_only %>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
              <input type="checkbox"
                     data-encounter-selection-target="selectAll">
            </th>
          <% end %>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provider</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Procedure Codes</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Diagnosis Codes</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Service</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" data-encounter-selection-target="tableBody">
        <% if encounters.present? && encounters.any? %>
          <% encounters.each do |encounter| %>
            <tr class="hover:bg-gray-50">
              <% if show_queued_only %>
                <td class="px-6 py-4 whitespace-nowrap">
                  <input type="checkbox"
                         name="encounter_ids[]"
                         value="<%= encounter.id %>"
                         data-encounter-selection-target="checkbox">
                </td>
              <% end %>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">
                  <%= encounter.patient.first_name %> <%= encounter.patient.last_name %>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">
                  <%= encounter.provider.full_name %>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  <% 
                    # Get procedure codes from encounter_procedure_items (preferred) or claim lines (fallback)
                    procedure_codes = encounter.all_procedure_codes
                    
                    if procedure_codes.any?
                      displayed_codes = procedure_codes.first(2)
                      remaining_count = procedure_codes.count - 2
                  %>
                    <%= displayed_codes.map(&:code).join(", ") %>
                    <% if remaining_count > 0 %>
                      <span class="text-gray-500">, +<%= remaining_count %> more</span>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">—</span>
                  <% end %>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  <% 
                    diagnosis_codes = encounter.diagnosis_codes.limit(5).to_a
                    if diagnosis_codes.any?
                  %>
                    <%= diagnosis_codes.map(&:code).join(", ") %>
                  <% else %>
                    <span class="text-gray-400">—</span>
                  <% end %>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">
                  <%= encounter.date_of_service.strftime("%m/%d/%Y") %>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= encounter.tenant_visible_status_badge_color %>">
                  <%= encounter.tenant_visible_status_label %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex space-x-2">
                  <%= link_to "View", tenant_encounter_path(encounter), class: "text-blue-600 hover:text-blue-800" %>
                  <% if encounter.claim&.edi_file&.attached? %>
                    <%= link_to "Download EDI", download_edi_tenant_encounter_path(encounter), class: "text-green-600 hover:text-green-800", title: "Download EDI file" %>
                  <% end %>
                  <% unless show_submitted_only %>
                    <% if encounter.ready_to_submit? && !encounter.cascaded? %>
                      <%= link_to "Edit", edit_tenant_encounter_path(encounter), class: "text-indigo-600 hover:text-indigo-800" %>
                    <% end %>
                    
                    <% if encounter.ready_for_review? && encounter.may_mark_reviewed? %>
                      <%= button_to "Mark as Reviewed", mark_reviewed_tenant_encounter_path(encounter),
                          method: :post,
                          form: { class: "inline-block" },
                          class: "text-blue-600 hover:text-blue-800",
                          data: { turbo_confirm: "Mark this encounter as reviewed?" } %>
                    <% end %>
                    
                    <% if encounter.reviewed? && encounter.may_mark_ready_to_submit? %>
                      <%= button_to "Mark Ready to Submit", mark_ready_to_submit_tenant_encounter_path(encounter),
                          method: :post,
                          form: { class: "inline-block" },
                          class: "text-green-600 hover:text-green-800",
                          data: { turbo_confirm: "Mark this encounter as ready to submit to billing?" } %>
                    <% end %>
                    
                    <% if encounter.can_be_cancelled? %>
                      <%= button_to "Cancel", cancel_tenant_encounter_path(encounter),
                          method: :post,
                          form: { class: "inline-block" },
                          class: "text-red-600 hover:text-red-800",
                          data: { turbo_confirm: "Are you sure you want to cancel this encounter?" } %>
                    <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <% if encounters.empty? %>
    <div class="text-center py-12">
      <div class="text-gray-500 text-lg">
        <% if show_queued_only %>
          No encounters ready to be sent
        <% elsif show_submitted_only %>
          No submitted encounters found
        <% else %>
          No encounters found
        <% end %>
      </div>
      <div class="text-gray-400 text-sm mt-2">
        <% if show_queued_only %>
          Encounters will appear here after they are saved for submission. Use "Prepare a New Encounter" to create encounters.
        <% elsif show_submitted_only %>
          Encounters will appear here after they are submitted to billing.
        <% else %>
          Try adjusting your filters or create a new encounter
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Pagination -->
<div class="mt-6" id="encounters_pagination">
  <%== pagination_info(pagy) %>
</div>

