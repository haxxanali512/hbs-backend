<% 
  # Reusable EZclaim import modal for any resource type
  # Usage: render "shared/ezclaim_import_modal", 
  #   resource_type: "payers", 
  #   resource_name: "Payers",
  #   fetch_url: admin_payers_fetch_from_ezclaim_path,
  #   save_url: admin_payers_save_from_ezclaim_path,
  #   display_columns: [:name, :payer_id, :payer_type, :status],
  #   modal_id: "ezclaimPayersModal"
  
  modal_id = local_assigns[:modal_id] || "ezclaim#{local_assigns[:resource_type]&.capitalize || 'Data'}Modal"
  resource_type = local_assigns[:resource_type] || "data"
  resource_name = local_assigns[:resource_name] || resource_type.humanize
  fetch_url = local_assigns[:fetch_url]
  save_url = local_assigns[:save_url]
  display_columns = local_assigns[:display_columns] || []
%>

<!-- EZClaim Import Modal -->
<div id="<%= modal_id %>" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="<%= modal_id %>-title" role="dialog" aria-modal="true">
  <div class="relative flex min-h-full items-center justify-center p-4">
    <!-- Background overlay -->
    <div id="<%= modal_id %>Overlay" class="absolute inset-0 bg-black/40 transition-opacity duration-300 ease-in-out opacity-0" onclick="closeEzclaimImportModal('<%= modal_id %>')"></div>

    <!-- Modal panel -->
    <div id="<%= modal_id %>Content" class="relative z-10 w-full max-w-6xl rounded-lg bg-white shadow-xl transform transition-all duration-300 ease-in-out scale-95 opacity-0">
      <div class="bg-white px-6 py-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900" id="<%= modal_id %>-title">Import <%= resource_name %> from EZClaim</h3>
          <button type="button" onclick="closeEzclaimImportModal('<%= modal_id %>')" class="text-gray-400 hover:text-gray-500">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Loading State -->
        <div id="<%= modal_id %>Loading" class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-4 text-sm text-gray-600">Fetching <%= resource_name.downcase %> from EZClaim...</p>
        </div>

        <!-- Success State with Table -->
        <div id="<%= modal_id %>Success" class="hidden">
          <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
            <div class="flex items-center">
              <svg class="h-5 w-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              <p class="text-sm font-medium text-green-800"><%= resource_name %> loaded successfully!</p>
            </div>
          </div>

          <div id="<%= modal_id %>TableContainer">
            <!-- Table will be rendered here -->
          </div>

          <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200">
            <button type="button" onclick="closeEzclaimImportModal('<%= modal_id %>')" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              Cancel
            </button>
            <button type="button" onclick="saveEzclaimData('<%= modal_id %>', '<%= save_url %>', '<%= resource_type %>')" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
              Save to DB (<span id="<%= modal_id %>SelectedCount">0</span> selected)
            </button>
          </div>
        </div>

        <!-- Error State -->
        <div id="<%= modal_id %>Error" class="hidden">
          <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
            <div class="flex items-center">
              <svg class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
              <p class="text-sm font-medium text-red-800">Failed to fetch <%= resource_name.downcase %></p>
            </div>
          </div>

          <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-2">Error Details</h4>
            <div class="bg-red-50 border border-red-200 rounded-md p-4">
              <p class="text-sm text-red-800" id="<%= modal_id %>ErrorMessage"></p>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="button" onclick="closeEzclaimImportModal('<%= modal_id %>')" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Store configuration for this modal
  window.ezclaimModalConfig = window.ezclaimModalConfig || {};
  window.ezclaimModalConfig['<%= modal_id %>'] = {
    resourceType: '<%= resource_type %>',
    resourceName: '<%= resource_name %>',
    displayColumns: <%= display_columns.to_json.html_safe %>
  };

  function openEzclaimImportModal(modalId, fetchUrl) {
    modalId = modalId || 'ezclaimDataModal';
    const modal = document.getElementById(modalId);
    const overlay = document.getElementById(modalId + 'Overlay');
    const content = document.getElementById(modalId + 'Content');
    
    if (!modal || !overlay || !content) return;
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Reset states
    const loading = document.getElementById(modalId + 'Loading');
    const success = document.getElementById(modalId + 'Success');
    const error = document.getElementById(modalId + 'Error');
    
    if (loading) loading.classList.remove('hidden');
    if (success) success.classList.add('hidden');
    if (error) error.classList.add('hidden');
    
    // Trigger fade in animation
    requestAnimationFrame(() => {
      overlay.classList.remove('opacity-0');
      overlay.classList.add('opacity-100');
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    });
    
    // Fetch data from EZclaim
    if (fetchUrl) {
      fetchEzclaimData(modalId, fetchUrl);
    }
  }

  function closeEzclaimImportModal(modalId) {
    modalId = modalId || 'ezclaimDataModal';
    const modal = document.getElementById(modalId);
    const overlay = document.getElementById(modalId + 'Overlay');
    const content = document.getElementById(modalId + 'Content');
    
    if (!modal || !overlay || !content) return;
    
    // Trigger fade out animation
    overlay.classList.remove('opacity-100');
    overlay.classList.add('opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');
    
    // Hide modal after animation completes
    setTimeout(() => {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }, 300);
  }

  function fetchEzclaimData(modalId, fetchUrl) {
    modalId = modalId || 'ezclaimDataModal';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    fetch(fetchUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to fetch data');
        });
      }
      return response.json();
    })
    .then(data => {
      const loading = document.getElementById(modalId + 'Loading');
      const success = document.getElementById(modalId + 'Success');
      const error = document.getElementById(modalId + 'Error');
      
      if (loading) loading.classList.add('hidden');
      
      console.log('EZClaim fetch response:', data);
      
      if (data.success && data.data) {
        // Ensure data.data is an array
        let items = data.data;
        
        console.log('EZClaim items type:', typeof items, 'isArray:', Array.isArray(items));
        
        if (!Array.isArray(items)) {
          // If it's an object, try to extract array from common keys
          if (items.Data && Array.isArray(items.Data)) {
            items = items.Data;
          } else if (items.data && Array.isArray(items.data)) {
            items = items.data;
          } else if (items.items && Array.isArray(items.items)) {
            items = items.items;
          } else if (items.results && Array.isArray(items.results)) {
            items = items.results;
          } else if (items && typeof items === 'object') {
            // Try to find any array value in the object
            const keys = Object.keys(items);
            for (const key of keys) {
              if (Array.isArray(items[key])) {
                items = items[key];
                break;
              }
            }
            // If still not an array, wrap it
            if (!Array.isArray(items)) {
              items = [items];
            }
          } else {
            // If it's a single object, wrap it in an array
            items = [items];
          }
        }
        
        console.log('EZClaim final items:', items, 'count:', items.length);
        
        // Show success state and render table
        if (success) success.classList.remove('hidden');
        renderEzclaimDataTable(modalId, items, data.resource_type || 'data');
      } else {
        // Show error state
        if (error) error.classList.remove('hidden');
        const errorMessage = document.getElementById(modalId + 'ErrorMessage');
        if (errorMessage) errorMessage.textContent = data.error || 'Failed to fetch data';
      }
    })
    .catch(error => {
      const loading = document.getElementById(modalId + 'Loading');
      const errorDiv = document.getElementById(modalId + 'Error');
      const errorMessage = document.getElementById(modalId + 'ErrorMessage');
      
      if (loading) loading.classList.add('hidden');
      if (errorDiv) errorDiv.classList.remove('hidden');
      if (errorMessage) errorMessage.textContent = 'Error: ' + error.message;
    });
  }

  function renderEzclaimDataTable(modalId, items, resourceType) {
    const container = document.getElementById(modalId + 'TableContainer');
    if (!container) return;

    // Ensure items is an array
    if (!Array.isArray(items)) {
      console.error('Items is not an array:', items);
      items = [];
    }

    if (items.length === 0) {
      container.innerHTML = '<p class="text-center py-8 text-gray-500">No items found</p>';
      return;
    }

    const config = window.ezclaimModalConfig[modalId] || {};
    const displayColumns = config.displayColumns || [];
    
    // Get all available keys from the first item
    const firstItem = items[0];
    const availableKeys = Object.keys(firstItem);
    
    // Helper function to find a key (case-insensitive, handles snake_case, camelCase, etc.)
    function findKey(desiredKey, availableKeys) {
      const lowerDesired = String(desiredKey).toLowerCase();
      
      // Exact match
      if (availableKeys.includes(desiredKey)) return desiredKey;
      if (availableKeys.includes(String(desiredKey))) return String(desiredKey);
      
      // Case-insensitive match
      for (const key of availableKeys) {
        if (key.toLowerCase() === lowerDesired) return key;
      }
      
      // Partial match (e.g., "payer_id" matches "PayerID" or "payerId")
      const normalizedDesired = lowerDesired.replace(/[_-]/g, '');
      for (const key of availableKeys) {
        const normalizedKey = key.toLowerCase().replace(/[_-]/g, '');
        if (normalizedKey === normalizedDesired) return key;
      }
      
      return null;
    }
    
    // If display columns specified, map them to actual keys
    let columns = [];
    if (displayColumns.length > 0) {
      const foundColumns = displayColumns.map(col => findKey(col, availableKeys)).filter(Boolean);
      
      // If we found matching columns, use them
      if (foundColumns.length > 0) {
        columns = foundColumns;
      } else {
        // If none matched, use all available keys and log for debugging
        console.warn('Display columns did not match any available keys. Using all available keys:', availableKeys);
        columns = availableKeys;
      }
    } else {
      // Use all available keys
      columns = availableKeys;
    }
    
    // Log for debugging
    console.log('Rendering table with columns:', columns);
    console.log('First item keys:', availableKeys);
    console.log('First item sample:', firstItem);

    let tableHtml = `
      <div class="space-y-4">
        <div>
          <input type="text" 
                 id="${modalId}Search" 
                 placeholder="Search..." 
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 onkeyup="filterEzclaimTable('${modalId}Search', '${modalId}Table')">
        </div>
        <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-md">
          <table id="${modalId}Table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <input type="checkbox" 
                         id="${modalId}SelectAll" 
                         class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                         onchange="toggleAllEzclaimRows('${modalId}Table', this.checked, '${modalId}')">
                </th>
                ${columns.map(col => `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${String(col).humanize}</th>`).join('')}
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
    `;

    items.forEach((item, index) => {
      tableHtml += `
        <tr class="ezclaim-row hover:bg-gray-50" data-index="${index}">
          <td class="px-4 py-3 whitespace-nowrap">
            <input type="checkbox" 
                   class="ezclaim-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                   data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'
                   onchange="updateEzclaimSelection('${modalId}')">
          </td>
          ${columns.map(col => {
            // Try to find the value using the key
            let value = '';
            if (item.hasOwnProperty(col)) {
              value = item[col];
            } else {
              // Try case-insensitive match
              const foundKey = Object.keys(item).find(k => k.toLowerCase() === String(col).toLowerCase());
              if (foundKey) {
                value = item[foundKey];
              } else {
                // Try normalized match (remove underscores/dashes)
                const normalizedCol = String(col).toLowerCase().replace(/[_-]/g, '');
                const foundKey2 = Object.keys(item).find(k => k.toLowerCase().replace(/[_-]/g, '') === normalizedCol);
                if (foundKey2) {
                  value = item[foundKey2];
                }
              }
            }
            
            // Format the value for display
            if (value === null || value === undefined) {
              value = '';
            } else if (typeof value === 'object') {
              value = JSON.stringify(value);
            } else {
              value = String(value);
            }
            
            return `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${value || 'â€”'}</td>`;
          }).join('')}
        </tr>
      `;
    });

    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    container.innerHTML = tableHtml;
    updateEzclaimSelection(modalId);
  }

  function toggleAllEzclaimRows(tableId, checked, modalId) {
    const checkboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox`);
    checkboxes.forEach(checkbox => {
      checkbox.checked = checked;
    });
    updateEzclaimSelection(modalId);
  }

  function updateEzclaimSelection(modalId) {
    const tableId = modalId + 'Table';
    const checkboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox:checked`);
    const selectAllCheckbox = document.getElementById(modalId + 'SelectAll');
    const countSpan = document.getElementById(modalId + 'SelectedCount');
    
    if (selectAllCheckbox) {
      const allCheckboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox`);
      selectAllCheckbox.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
      selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    }
    
    if (countSpan) {
      countSpan.textContent = checkboxes.length;
    }
  }

  function filterEzclaimTable(searchId, tableId) {
    const searchInput = document.getElementById(searchId);
    const table = document.getElementById(tableId);
    if (!searchInput || !table) return;
    
    const filter = searchInput.value.toLowerCase();
    const rows = table.getElementsByClassName('ezclaim-row');
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? '' : 'none';
    }
  }

  function saveEzclaimData(modalId, saveUrl, resourceType) {
    const tableId = modalId + 'Table';
    const checkboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox:checked`);
    const selectedItems = Array.from(checkboxes).map(checkbox => {
      try {
        return JSON.parse(checkbox.getAttribute('data-item'));
      } catch (e) {
        return null;
      }
    }).filter(item => item !== null);

    if (selectedItems.length === 0) {
      alert('Please select at least one item to save.');
      return;
    }

    const saveButton = event.target;
    const originalText = saveButton.textContent;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    // Use resource type to determine the data key (e.g., "payers", "patients")
    // Handle pluralization: payer -> payers, patient -> patients, etc.
    let dataKey = resourceType;
    if (!resourceType.endsWith('s')) {
      if (resourceType.endsWith('y')) {
        dataKey = resourceType.slice(0, -1) + 'ies';
      } else {
        dataKey = resourceType + 's';
      }
    }
    const payload = {};
    payload[dataKey] = selectedItems;
    
    fetch(saveUrl, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      body: JSON.stringify(payload),
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to save data');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert(`Successfully saved ${data.saved_count || selectedItems.length} item(s).`);
        window.location.reload();
      } else {
        alert('Failed to save: ' + (data.error || 'Unknown error'));
        saveButton.disabled = false;
        saveButton.textContent = originalText;
      }
    })
    .catch(error => {
      alert('Error: ' + error.message);
      saveButton.disabled = false;
      saveButton.textContent = originalText;
    });
  }
</script>

