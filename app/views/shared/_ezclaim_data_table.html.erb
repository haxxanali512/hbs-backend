<% 
  # Reusable partial for displaying EZclaim API data in a table
  # Usage: render "shared/ezclaim_data_table", data: @ezclaim_data, columns: [:name, :id, :type], selectable: true
  data = local_assigns[:data] || []
  columns = local_assigns[:columns] || []
  selectable = local_assigns[:selectable] != false
  table_id = local_assigns[:table_id] || 'ezclaimDataTable'
  search_id = local_assigns[:search_id] || 'ezclaimSearch'
%>

<div class="space-y-4">
  <!-- Search -->
  <div>
    <input type="text" 
           id="<%= search_id %>" 
           placeholder="Search..." 
           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
           onkeyup="filterEzclaimTable('<%= search_id %>', '<%= table_id %>')">
  </div>

  <!-- Table -->
  <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-md">
    <table id="<%= table_id %>" class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50 sticky top-0">
        <tr>
          <% if selectable %>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <input type="checkbox" 
                     id="<%= table_id %>SelectAll" 
                     class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                     onchange="toggleAllEzclaimRows('<%= table_id %>', this.checked)">
            </th>
          <% end %>
          <% columns.each do |column| %>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <%= column.to_s.humanize %>
            </th>
          <% end %>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% if data.present? && data.any? %>
          <% data.each_with_index do |item, index| %>
            <tr class="ezclaim-row hover:bg-gray-50" data-index="<%= index %>">
              <% if selectable %>
                <td class="px-4 py-3 whitespace-nowrap">
                  <input type="checkbox" 
                         class="ezclaim-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                         data-item='<%= item.to_json %>'
                         onchange="updateEzclaimSelection('<%= table_id %>')">
                </td>
              <% end %>
              <% columns.each do |column| %>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= item.is_a?(Hash) ? item[column.to_s] || item[column.to_sym] : item.send(column) rescue '' %>
                </td>
              <% end %>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="<%= columns.length + (selectable ? 1 : 0) %>" class="px-4 py-8 text-center text-sm text-gray-500">
              No data available
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
  function filterEzclaimTable(searchId, tableId) {
    const searchInput = document.getElementById(searchId);
    const table = document.getElementById(tableId);
    const filter = searchInput.value.toLowerCase();
    const rows = table.getElementsByClassName('ezclaim-row');
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? '' : 'none';
    }
  }

  function toggleAllEzclaimRows(tableId, checked) {
    const checkboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox`);
    checkboxes.forEach(checkbox => {
      checkbox.checked = checked;
    });
    updateEzclaimSelection(tableId);
  }

  function updateEzclaimSelection(tableId) {
    const checkboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox:checked`);
    const selectAllCheckbox = document.getElementById(`${tableId}SelectAll`);
    if (selectAllCheckbox) {
      const allCheckboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox`);
      selectAllCheckbox.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
      selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    }
  }

  function getSelectedEzclaimItems(tableId) {
    const checkboxes = document.querySelectorAll(`#${tableId} .ezclaim-checkbox:checked`);
    return Array.from(checkboxes).map(checkbox => {
      try {
        return JSON.parse(checkbox.getAttribute('data-item'));
      } catch (e) {
        return null;
      }
    }).filter(item => item !== null);
  }
</script>

