<aside class="hidden md:flex fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex-col">
  <div class="h-16 flex items-center justify-center border-b border-gray-200">
    <%= link_to (current_user.super_admin? && current_organization.nil? ? admin_dashboard_path : tenant_dashboard_path), class: "flex items-center space-x-3" do %>
      <%= image_tag "HBS-logo-scaled (1).png", alt: "Holistic Business Solution", class: "h-8 w-auto" %>
    <% end %>
  </div>

  <nav class="flex-1 overflow-y-auto py-4">
    <div class="px-4 text-[10px] font-semibold uppercase text-gray-400 tracking-widest mb-2">Menu</div>
    <ul class="space-y-1 px-2">
      <% if current_user.super_admin? && current_organization.nil? || current_user.dashboard_type == "hbs_dashboard" %>
        <!-- Global Admin Sidebar: Top-level (no umbrella) -->
        <li>
          <% dashboard_active = current_page?(admin_dashboard_path) %>
          <%= link_to admin_dashboard_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{dashboard_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{dashboard_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M4.5 10.5V21h15V10.5"/></svg>
            <span>Dashboard</span>
          <% end %>
        </li>
        <% if current_user.permissions_for("admin", "encounters", "index") %>
        <li>
          <% billing_queue_active = controller_path == 'admin/encounters' && action_name == 'billing_queue' %>
          <%= link_to billing_queue_admin_encounters_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{billing_queue_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{billing_queue_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.761 0-5 1.343-5 3s2.239 3 5 3 5 1.343 5 3-2.239 3-5 3M12 5v2m0 10v2"/></svg>
            <span>Billing Queue</span>
          <% end %>
        </li>
        <% end %>

        <% practice_admin_active = controller_path == 'admin/organizations' || controller_path == 'admin/organization_locations' || controller_path == 'admin/providers' || controller_path == 'admin/fee_schedules' || controller_path == 'admin/audits' %>
        <% revenue_admin_active = (controller_path == 'admin/encounters' && action_name == 'index') || controller_path == 'admin/claims' || controller_path == 'admin/payments' || controller_path == 'admin/appointments' %>
        <% patients_admin_active = controller_path == 'admin/patients' || controller_path == 'admin/patient_insurance_coverages' %>
        <% reference_admin_active = controller_path == 'admin/encounter_templates' || controller_path == 'admin/payers' || controller_path == 'admin/insurance_plans' || controller_path == 'admin/org_accepted_plans' || controller_path == 'admin/specialties' || controller_path == 'admin/procedure_codes' || controller_path == 'admin/diagnosis_codes' %>
        <% platform_admin_active = controller_path == 'admin/organization_billings' || controller_path == 'admin/invoices' || controller_path == 'admin/users' || controller_path == 'admin/roles' || controller_path == 'admin/email_template_keys' || controller_path == 'admin/data_exports_imports' || controller_path == 'admin/support_tickets' %>

        <!-- Practice Administration (collapsible) -->
        <li class="mt-5">
          <button type="button"
                  class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                  data-sidebar-section="admin-practice"
                  data-section-active="<%= practice_admin_active %>">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V3M12 6a3 3 0 013 3h3M12 6a3 3 0 00-3 3H6m6 9v3m0-3a3 3 0 01-3-3H6m6 3a3 3 0 003-3h3M6 9h12M6 15h12"/></svg>
              <span>Practice Administration</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="admin-practice">
            <% if current_user.permissions_for("admin", "organizations", "index") %>
              <li>
                <% orgs_active = controller_path == 'admin/organizations' %>
                <%= link_to admin_organizations_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{orgs_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{orgs_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                  <span>Organizations</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "organization_locations", "index") %>
              <li>
                <% organization_locations_active = controller_path == 'admin/organization_locations' %>
                <%= link_to admin_organization_locations_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{organization_locations_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{organization_locations_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <span>Organization Locations</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "providers", "index") %>
              <li>
                <% providers_active = controller_path == 'admin/providers' %>
                <%= link_to admin_providers_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{providers_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{providers_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20v-1a4 4 0 00-4-4H7a4 4 0 00-4 4v1M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a4 4 0 100-8 4 4 0 000 8z"/></svg>
                  <span>Providers</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "fee_schedules", "index") %>
              <li>
                <% fee_schedules_active = controller_path == 'admin/fee_schedules' %>
                <%= link_to admin_fee_schedules_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{fee_schedules_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{fee_schedules_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
                  <span>Fee Schedules</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "audits", "index") %>
              <li>
                <% audits_active = controller_path == 'admin/audits' %>
                <%= link_to admin_audits_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{audits_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{audits_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                  <span>Audits</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </li>

        <!-- Revenue Cycle Operations (collapsible) -->
        <li class="mt-5">
          <button type="button"
                  class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                  data-sidebar-section="admin-revenue"
                  data-section-active="<%= revenue_admin_active %>">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.761 0-5 1.343-5 3s2.239 3 5 3 5 1.343 5 3-2.239 3-5 3M12 5v2m0 10v2"/></svg>
              <span>Revenue Cycle Operations</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="admin-revenue">
            <% if current_user.permissions_for("admin", "encounters", "index") %>
              <li>
                <% encounters_active = controller_path == 'admin/encounters' && action_name == 'index' %>
                <%= link_to admin_encounters_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{encounters_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{encounters_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                  <span>Encounters</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "claims", "index") %>
              <li>
                <% claims_active = controller_path == 'admin/claims' %>
                <%= link_to admin_claims_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{claims_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{claims_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  <span>Claims</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "payments", "index") %>
              <li>
                <% payments_active = controller_path == 'admin/payments' %>
                <%= link_to admin_payments_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{payments_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{payments_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.761 0-5 1.343-5 3s2.239 3 5 3 5 1.343 5 3-2.239 3-5 3M12 5v2m0 10v2"/></svg>
                  <span>Payments</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "appointments", "index") %>
              <li>
                <% appointments_active = controller_path == 'admin/appointments' %>
                <%= link_to admin_appointments_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{appointments_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{appointments_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  <span>Appointments</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </li>

        <!-- Patient Records (collapsible) -->
        <li class="mt-5">
          <button type="button"
                  class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                  data-sidebar-section="admin-patients"
                  data-section-active="<%= patients_admin_active %>">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12a4 4 0 100-8 4 4 0 000 8zM4 20a8 8 0 0116 0"/></svg>
              <span>Patient Records</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="admin-patients">
            <% if current_user.permissions_for("admin", "patients", "index") %>
              <li>
                <% patients_active = controller_path == 'admin/patients' %>
                <%= link_to admin_patients_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{patients_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{patients_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                  <span>Patients</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "patient_insurance_coverages", "index") %>
              <li>
                <% coverages_active = controller_path == 'admin/patient_insurance_coverages' %>
                <%= link_to admin_patient_insurance_coverages_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{coverages_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{coverages_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                  <span>Insurance Coverages</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </li>

        <!-- Reference Data & Templates (collapsible) -->
        <li class="mt-5">
          <button type="button"
                  class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                  data-sidebar-section="admin-reference"
                  data-section-active="<%= reference_admin_active %>">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
              <span>Reference Data &amp; Templates</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="admin-reference">
            <% if current_user.permissions_for("admin", "encounter_templates", "index") %>
              <li>
                <% templates_active = controller_path == 'admin/encounter_templates' %>
                <%= link_to admin_encounter_templates_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{templates_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{templates_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5h6a2 2 0 012 2v12a2 2 0 01-2 2H9a2 2 0 01-2-2V7a2 2 0 012-2zm3 4h4m-4 4h4m-4 4h4M7 9h.01M7 13h.01M7 17h.01"/></svg>
                  <span>Encounter Templates</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "payers", "index") %>
              <li>
                <% payers_active = controller_path == 'admin/payers' %>
                <%= link_to admin_payers_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{payers_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{payers_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                  <span>Payers</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "insurance_plans", "index") %>
              <li>
                <% insurance_plans_active = controller_path == 'admin/insurance_plans' %>
                <%= link_to admin_insurance_plans_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{insurance_plans_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{insurance_plans_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                  <span>Insurance Plans</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "org_accepted_plans", "index") %>
              <li>
                <% org_accepted_plans_active = controller_path == 'admin/org_accepted_plans' %>
                <%= link_to admin_org_accepted_plans_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{org_accepted_plans_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{org_accepted_plans_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span>Accepted Plans</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "specialties", "index") %>
              <li>
                <% specialties_active = controller_path == 'admin/specialties' %>
                <%= link_to admin_specialties_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{specialties_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{specialties_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                  <span>Specialties</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "procedure_codes", "index") %>
              <li>
                <% procedure_codes_active = controller_path == 'admin/procedure_codes' %>
                <%= link_to admin_procedure_codes_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{procedure_codes_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{procedure_codes_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                  <span>Procedure Codes</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "diagnosis_codes", "index") %>
              <li>
                <% diagnosis_codes_active = controller_path == 'admin/diagnosis_codes' %>
                <%= link_to admin_diagnosis_codes_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{diagnosis_codes_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{diagnosis_codes_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                  <span>Diagnosis Codes</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </li>

        <!-- Platform & Access Control (collapsible) -->
        <li class="mt-5">
          <button type="button"
                  class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                  data-sidebar-section="admin-platform"
                  data-section-active="<%= platform_admin_active %>">
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
              <span>Platform &amp; Access Control</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="admin-platform">
            <% if current_user.permissions_for("admin", "organization_billings", "index") %>
              <li>
                <% organization_billings_active = controller_path == 'admin/organization_billings' %>
                <%= link_to admin_organization_billings_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{organization_billings_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{organization_billings_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.761 0-5 1.343-5 3s2.239 3 5 3 5 1.343 5 3-2.239 3-5 3M12 5v2m0 10v2"/></svg>
                  <span>Billing Management</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "invoices", "index") %>
              <li>
                <% invoices_active = controller_path == 'admin/invoices' %>
                <%= link_to admin_invoices_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{invoices_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{invoices_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  <span>Invoices</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "users", "index") %>
              <li>
                <% users_active = controller_path == 'admin/users' %>
                <%= link_to admin_users_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{users_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{users_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                  <span>Users</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "roles", "index") %>
              <li>
                <% roles_active = controller_path == 'admin/roles' %>
                <%= link_to admin_roles_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{roles_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{roles_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                  <span>Roles</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "email_template_keys", "index") %>
              <li>
                <% email_template_keys_active = controller_path == 'admin/email_template_keys' %>
                <%= link_to admin_email_template_keys_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{email_template_keys_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{email_template_keys_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span>Email Template Keys</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "data_exports_imports", "index") %>
              <li>
                <% data_exports_imports_active = controller_path == 'admin/data_exports_imports' %>
                <%= link_to admin_data_exports_imports_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{data_exports_imports_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{data_exports_imports_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                  <span>Data Import / Export</span>
                <% end %>
              </li>
            <% end %>
            <% if current_user.permissions_for("admin", "support_tickets", "index") %>
              <li>
                <% support_tickets_active = controller_path == 'admin/support_tickets' %>
                <%= link_to admin_support_tickets_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{support_tickets_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 #{support_tickets_active ? 'text-indigo-600' : 'text-gray-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h8m-8 6h16"/></svg>
                  <span>Support Center</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </li>

      <% elsif current_user.dashboard_type == "tenant_dashboard" && current_organization.present? %>
        <!-- Tenant-specific Sidebar -->
        <% if current_organization.activated? %>
          <% dashboard_active = current_page?(tenant_dashboard_path) %>
          <% providers_active = controller_path == 'tenant/providers' %>
          <% specialties_active = controller_path == 'tenant/specialties' %>
          <% fee_schedules_active = controller_path == 'tenant/fee_schedules' %>
          <% org_locations_active = controller_path == 'tenant/organization_locations' %>
          <% accepted_plans_active = controller_path == 'tenant/org_accepted_plans' %>
          <% patients_active = controller_path == 'tenant/patients' %>
          <% coverages_active = controller_path == 'tenant/patient_insurance_coverages' %>
          <% encounters_active = controller_path == 'tenant/encounters' && action_name != 'workflow' %>
          <% prescriptions_active = controller_path == 'tenant/prescriptions' %>
          <% eligibility_checks_active = controller_path == 'tenant/eligibility_checks' %>
          <% procedure_codes_active = controller_path == 'tenant/procedure_codes' %>
          <% diagnosis_codes_active = controller_path == 'tenant/diagnosis_codes' %>
          <% invoices_active = controller_path == 'tenant/invoices' %>
          <% support_tickets_active = controller_path == 'tenant/support_tickets' %>
          <% settings_active = controller_path == 'tenant/organization_settings' %>

          <% practice_active = providers_active || specialties_active || fee_schedules_active || accepted_plans_active || org_locations_active %>
          <% clinical_active = patients_active || coverages_active || encounters_active || prescriptions_active || eligibility_checks_active %>
          <% codes_active = procedure_codes_active || diagnosis_codes_active %>
          <% financial_active = invoices_active || support_tickets_active || settings_active %>

          <% if current_user.permissions_for("tenant", "dashboard", "index") %>
            <li>
              <%= link_to tenant_dashboard_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{dashboard_active ? 'active' : ''} #{dashboard_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 text-current"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M4.5 10.5V21h15V10.5"/></svg>
                <span>Dashboard</span>
              <% end %>
            </li>
          <% end %>

          <li class="mt-5">
            <button type="button"
                    class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                    data-sidebar-section="practice"
                    data-section-active="<%= practice_active %>">
              <span class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V3M12 6a3 3 0 013 3h3M12 6a3 3 0 00-3 3H6m6 9v3m0-3a3 3 0 01-3-3H6m6 3a3 3 0 003-3h3M6 9h12M6 15h12"/></svg>
                <span>Practice Configuration</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="practice">
              <% if current_user.permissions_for("tenant", "providers", "index") %>
                <li>
                  <%= link_to tenant_providers_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{providers_active ? 'active' : ''} #{providers_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Providers</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "specialties", "index") %>
                <li>
                  <%= link_to tenant_specialties_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{specialties_active ? 'active' : ''} #{specialties_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Specialties</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "fee_schedules", "index") %>
                <li>
                  <%= link_to tenant_fee_schedules_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{fee_schedules_active ? 'active' : ''} #{fee_schedules_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Fee Schedules</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "org_accepted_plans", "index") %>
                <li>
                  <%= link_to tenant_org_accepted_plans_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{accepted_plans_active ? 'active' : ''} #{accepted_plans_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Accepted Plans</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "organization_locations", "index") %>
                <li>
                  <%= link_to tenant_organization_locations_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{org_locations_active ? 'active' : ''} #{org_locations_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Organization Locations</span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </li>

          <li class="mt-5">
            <button type="button"
                    class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                    data-sidebar-section="clinical"
                    data-section-active="<%= clinical_active %>">
              <span class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12a4 4 0 100-8 4 4 0 000 8zM4 20a8 8 0 0116 0"/></svg>
                <span>Patients &amp; Clinical Data</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="clinical">
              <% if current_user.permissions_for("tenant", "patients", "index") %>
                <li>
                  <%= link_to tenant_patients_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{patients_active ? 'active' : ''} #{patients_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Patients</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "patient_insurance_coverages", "index") %>
                <li>
                  <%= link_to tenant_patient_insurance_coverages_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{coverages_active ? 'active' : ''} #{coverages_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Insurance Coverages</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "encounters", "index") %>
                <li>
                  <%= link_to tenant_encounters_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{encounters_active ? 'active' : ''} #{encounters_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Encounters</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "prescriptions", "index") %>
                <li>
                  <%= link_to tenant_prescriptions_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{prescriptions_active ? 'active' : ''} #{prescriptions_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Prescriptions</span>
                  <% end %>
                </li>
              <% end %>
              <li>
                <%= link_to tenant_eligibility_checks_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{eligibility_checks_active ? 'active' : ''} #{eligibility_checks_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                  <span>Eligibility Check</span>
                <% end %>
              </li>
            </ul>
          </li>

          <li class="mt-5">
            <button type="button"
                    class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                    data-sidebar-section="codes"
                    data-section-active="<%= codes_active %>">
              <span class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                <span>Codes &amp; Rules</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="codes">
              <% if current_user.permissions_for("tenant", "procedure_codes", "index") %>
                <li>
                  <%= link_to tenant_procedure_codes_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{procedure_codes_active ? 'active' : ''} #{procedure_codes_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Procedure Codes</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "diagnosis_codes", "index") %>
                <li>
                  <%= link_to tenant_diagnosis_codes_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{diagnosis_codes_active ? 'active' : ''} #{diagnosis_codes_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Diagnosis Codes</span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </li>

          <li class="mt-5">
            <button type="button"
                    class="group w-full flex items-center justify-between text-left text-xs font-semibold uppercase tracking-widest text-[#173D6C] px-3 py-1.5 hover:text-[#2FAD6F] hover:bg-transparent rounded-md"
                    data-sidebar-section="financial"
                    data-section-active="<%= financial_active %>">
              <span class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.761 0-5 1.343-5 3s2.239 3 5 3 5 1.343 5 3-2.239 3-5 3M12 5v2m0 10v2"/></svg>
                <span>Financial &amp; System</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-current transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <ul class="space-y-1 pl-7 overflow-hidden transition-[max-height] duration-200 ease-out" data-sidebar-section-content="financial">
              <% if current_user.permissions_for("tenant", "invoices", "index") %>
                <li>
                  <%= link_to tenant_invoices_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{invoices_active ? 'active' : ''} #{invoices_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Invoices</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "support_tickets", "index") %>
                <li>
                  <%= link_to tenant_support_tickets_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{support_tickets_active ? 'active' : ''} #{support_tickets_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Support Center</span>
                  <% end %>
                </li>
              <% end %>
              <% if current_user.permissions_for("tenant", "organization_settings", "show") %>
                <li>
                  <%= link_to tenant_organization_setting_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{settings_active ? 'active' : ''} #{settings_active ? 'bg-[rgba(47,173,111,0.1)] text-[#2FAD6F80]' : 'text-[#173D6C] hover:text-[#2FAD6F] hover:bg-transparent'}" do %>
                    <span>Settings</span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </li>
        <% else %>
          <% if current_user.permissions_for("tenant", "activation", "index") %>
            <li>
              <% activation_active = controller_path == 'tenant/dashboard' && action_name == 'activation' %>
              <%= link_to tenant_activation_path, class: "flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium #{activation_active ? 'bg-indigo-50 text-indigo-700' : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'}" do %>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="h-5 w-5 #{activation_active ? 'text-indigo-600' : 'text-gray-500'}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Complete Setup</span>
              <% end %>
            </li>
          <% end %>
      <% end %>
      <% end %>
    </ul>
  </nav>
  
  <!-- Footer Section -->
  <div class="border-t border-gray-200 p-4">
    <% if current_user.super_admin? %>
      <!-- Organization Switcher for Super Admins -->
      <div class="mb-4">
        <div class="text-xs font-semibold uppercase text-gray-400 tracking-widest mb-2">Organization</div>
        <% if current_organization %>
          <div class="text-sm text-gray-900 font-medium mb-2"><%= current_organization.name %></div>
          <div class="text-xs text-gray-500 mb-3"><%= organization_subdomain_display(current_organization.subdomain) %></div>
          <%= link_to "Switch to Global Admin", admin_dashboard_path,
              class: "text-xs text-indigo-600 hover:text-indigo-800" %>
        <% else %>
          <div class="text-sm text-gray-900 font-medium mb-2">Global Admin</div>
          <div class="text-xs text-gray-500 mb-3"><%= organization_subdomain_display("admin") %></div>
          <div class="text-xs text-gray-500">Available Organizations:</div>
          <% Organization.limit(3).each do |org| %>
            <div class="text-xs">
              <%= link_to org.name, "#{request.protocol}#{organization_subdomain_url(org.subdomain)}",
                  class: "text-indigo-600 hover:text-indigo-800" %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
    
    <!-- User Info and Logout -->
    <div class="mb-3 text-xs text-gray-500">Signed in as</div>
    <div class="mb-4 text-sm font-medium text-gray-900 truncate"><%= current_user.display_name %></div>
    <%= button_to "Sign Out", destroy_user_session_path, method: :delete, class: "block w-full text-center px-3 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md border-0 cursor-pointer" %>
  </div>

  <script>
    document.addEventListener("turbo:load", function() {
      const sections = document.querySelectorAll("[data-sidebar-section]");
      if (!sections.length) return;

      const firstId = sections[0].getAttribute("data-sidebar-section");
      const isAdmin = firstId && firstId.indexOf("admin-") === 0;
      const storageKey = isAdmin ? "adminSidebarSections:<%= current_user&.id %>" : "tenantSidebarSections:<%= current_user&.id %>";
      const defaultExpanded = !isAdmin;
      const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");

      sections.forEach(function(button) {
        const sectionId = button.getAttribute("data-sidebar-section");
        const content = document.querySelector("[data-sidebar-section-content='" + sectionId + "']");
        const active = button.getAttribute("data-section-active") === "true";

        let expanded = saved[sectionId];
        if (expanded === undefined) expanded = defaultExpanded;
        if (active) expanded = true;

        button.setAttribute("aria-expanded", expanded);
        if (content) {
          content.setAttribute("aria-hidden", (!expanded).toString());
          content.style.maxHeight = expanded ? content.scrollHeight + "px" : "0px";
        }

        const icon = button.querySelector("svg:last-of-type");
        if (icon) icon.classList.toggle("rotate-180", expanded);

        button.addEventListener("click", function() {
          const isExpanded = button.getAttribute("aria-expanded") === "true";
          const nextExpanded = !isExpanded;
          button.setAttribute("aria-expanded", nextExpanded);
          if (content) {
            content.setAttribute("aria-hidden", (!nextExpanded).toString());
            content.style.maxHeight = nextExpanded ? content.scrollHeight + "px" : "0px";
          }
          if (icon) icon.classList.toggle("rotate-180", nextExpanded);
          saved[sectionId] = nextExpanded;
          localStorage.setItem(storageKey, JSON.stringify(saved));
        });
      });
    });
  </script>
</aside>