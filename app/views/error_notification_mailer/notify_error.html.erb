<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        background-color: #dc3545;
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .section {
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
      }
      .section-title {
        font-weight: bold;
        color: #dc3545;
        margin-bottom: 10px;
        font-size: 16px;
      }
      .code-block {
        background-color: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        margin-top: 10px;
      }
      .info-item {
        margin: 5px 0;
      }
      .label {
        font-weight: bold;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üö® Server Error Notification</h1>
      <p><strong>Environment:</strong> <%= @environment.upcase %></p>
      <p><strong>Time:</strong> <%= @timestamp.strftime("%Y-%m-%d %H:%M:%S %Z") %></p>
      <% if @error_fingerprint.present? %>
        <p><strong>Error Fingerprint:</strong> <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;"><%= @error_fingerprint %></code></p>
      <% end %>
    </div>

    <div class="section">
      <div class="section-title">Error Details</div>
      <div class="info-item">
        <span class="label">Exception Class:</span> <%= @exception.class.name %>
      </div>
      <div class="info-item">
        <span class="label">Error Message:</span> <%= @exception.message %>
      </div>
      <% if @exception_cause.present? %>
        <div class="info-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
          <span class="label">Caused by:</span> <%= @exception_cause.class.name %>
          <div style="margin-left: 20px; margin-top: 5px; color: #666;">
            <%= @exception_cause.message %>
          </div>
        </div>
      <% end %>
    </div>

    <% if @system_info.present? %>
      <div class="section">
        <div class="section-title">System Information</div>
        <% if @system_info[:ruby_version].present? %>
          <div class="info-item">
            <span class="label">Ruby Version:</span> <%= @system_info[:ruby_version] %>
          </div>
        <% end %>
        <% if @system_info[:rails_version].present? %>
          <div class="info-item">
            <span class="label">Rails Version:</span> <%= @system_info[:rails_version] %>
          </div>
        <% end %>
        <% if @system_info[:hostname].present? %>
          <div class="info-item">
            <span class="label">Hostname:</span> <%= @system_info[:hostname] %>
          </div>
        <% end %>
        <% if @system_info[:pid].present? %>
          <div class="info-item">
            <span class="label">Process ID:</span> <%= @system_info[:pid] %>
          </div>
        <% end %>
        <% if @system_info[:memory_usage].present? %>
          <div class="info-item">
            <span class="label">Memory Usage:</span> <%= @system_info[:memory_usage] %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @request_details.present? %>
      <div class="section">
        <div class="section-title"><%= @request_details[:job_class].present? ? "Background Job Information" : "Request Information" %></div>
        <% if @request_details[:job_class].present? %>
          <div class="info-item">
            <span class="label">Job Class:</span> <%= @request_details[:job_class] %>
          </div>
          <div class="info-item">
            <span class="label">Job ID:</span> <%= @request_details[:job_id] %>
          </div>
          <% if @request_details[:arguments].present? %>
            <div class="info-item" style="margin-top: 10px;">
              <span class="label">Job Arguments:</span>
              <div class="code-block">
                <%= JSON.pretty_generate(@request_details[:arguments]) %>
              </div>
            </div>
          <% end %>
        <% else %>
        <% if @request_details[:url].present? %>
          <div class="info-item">
            <span class="label">URL:</span> <%= @request_details[:url] %>
          </div>
        <% end %>
        <% if @request_details[:method].present? %>
          <div class="info-item">
            <span class="label">Method:</span> <%= @request_details[:method] %>
          </div>
        <% end %>
        <% if @request_details[:path].present? %>
          <div class="info-item">
            <span class="label">Path:</span> <%= @request_details[:path] %>
          </div>
        <% end %>
        <% if @request_details[:ip].present? %>
          <div class="info-item">
            <span class="label">IP Address:</span> <%= @request_details[:ip] %>
          </div>
        <% end %>
        <% if @request_details[:user_agent].present? %>
          <div class="info-item">
            <span class="label">User Agent:</span> <%= @request_details[:user_agent] %>
          </div>
        <% end %>
        <% if @request_details[:user_id].present? %>
          <div class="info-item">
            <span class="label">User ID:</span> <%= @request_details[:user_id] %>
          </div>
        <% end %>
        <% if @request_details[:organization_id].present? %>
          <div class="info-item">
            <span class="label">Organization ID:</span> <%= @request_details[:organization_id] %>
          </div>
        <% end %>
        <% if @request_details[:request_id].present? %>
          <div class="info-item">
            <span class="label">Request ID:</span> <%= @request_details[:request_id] %>
          </div>
        <% end %>
        <% if @request_details[:params].present? && @request_details[:params].any? %>
          <div class="info-item" style="margin-top: 10px;">
            <span class="label">Parameters:</span>
            <div class="code-block">
              <%= JSON.pretty_generate(@request_details[:params]) %>
            </div>
          </div>
        <% end %>
        <% end %>
      </div>
    <% end %>

    <% if @backtrace.any? %>
      <div class="section">
        <div class="section-title">
          Backtrace 
          <% if @backtrace_count > @backtrace.count %>
            (showing first <%= @backtrace.count %> of <%= @backtrace_count %> lines)
          <% else %>
            (<%= @backtrace_count %> lines)
          <% end %>
        </div>
        <div class="code-block">
          <% @backtrace.each_with_index do |line, index| %>
            <span style="color: #888; margin-right: 10px;"><%= index + 1 %>:</span><%= line %><br>
          <% end %>
          <% if @backtrace_count > @backtrace.count %>
            <br>
            <span style="color: #888; font-style: italic;">... <%= @backtrace_count - @backtrace.count %> more lines (check logs for full backtrace)</span>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="section" style="background-color: #fff3cd; border-left-color: #ffc107;">
      <div class="section-title" style="color: #856404;">‚ö†Ô∏è Next Steps</div>
      <ul>
        <li>Check the application logs for more details</li>
        <li>Review the request parameters and user context above</li>
        <% if @request_details[:request_id].present? %>
          <li>Use the Request ID to search logs: <code><%= @request_details[:request_id] %></code></li>
        <% end %>
        <% if @error_fingerprint.present? %>
          <li>Search for similar errors using fingerprint: <code><%= @error_fingerprint %></code></li>
        <% end %>
        <li>Check if this is a recurring issue or a one-time error</li>
        <% if @backtrace_count > @backtrace.count %>
          <li>Full backtrace available in application logs (showing <%= @backtrace.count %> of <%= @backtrace_count %> lines above)</li>
        <% end %>
      </ul>
    </div>
  </body>
</html>

