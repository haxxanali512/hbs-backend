<div class="min-h-screen bg-gray-50 py-8">
  <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900"><%= @insurance_plan.name %></h1>
          <p class="mt-2 text-gray-600">Insurance plan details and management</p>
        </div>
        <div class="flex space-x-3">
          <%= link_to "Back to Plans", admin_insurance_plans_path, class: "bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>
          <%= link_to "Edit", edit_admin_insurance_plan_path(@insurance_plan), class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Details</h2>
        <dl class="grid grid-cols-1 gap-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">Payer</dt>
            <dd class="text-sm text-gray-900 mt-1"><%= @insurance_plan.payer.name %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Plan Code</dt>
            <dd class="text-sm text-gray-900 mt-1 font-mono"><%= @insurance_plan.plan_code %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Plan Type</dt>
            <dd class="text-sm text-gray-900 mt-1"><%= @insurance_plan.plan_type.humanize %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Status</dt>
            <dd class="text-sm mt-1">
              <span class="px-2 py-1 text-xs font-medium rounded-full <%= @insurance_plan.status_badge_class %>">
                <%= @insurance_plan.status.humanize %>
              </span>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">State Scope</dt>
            <dd class="text-sm text-gray-900 mt-1"><%= (@insurance_plan.state_scope || []).join(', ').presence || 'National' %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Contact URL</dt>
            <dd class="text-sm text-blue-700 mt-1"><%= @insurance_plan.contact_url.presence || '—' %></dd>
          </div>
        </dl>
      </div>

      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Validation Formats</h2>
        <dl class="grid grid-cols-1 gap-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">Member ID Format</dt>
            <dd class="text-sm text-gray-900 mt-1 font-mono"><%= @insurance_plan.member_id_format.presence || '—' %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Group Number Format</dt>
            <dd class="text-sm text-gray-900 mt-1 font-mono"><%= @insurance_plan.group_number_format.presence || '—' %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Internal Notes</dt>
            <dd class="text-sm text-gray-900 mt-1 whitespace-pre-wrap"><%= @insurance_plan.notes_internal.presence || '—' %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Created At</dt>
            <dd class="text-sm text-gray-900 mt-1"><%= @insurance_plan.created_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Updated At</dt>
            <dd class="text-sm text-gray-900 mt-1"><%= @insurance_plan.updated_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
        </dl>
      </div>
    </div>

    <!-- Dependencies -->
    <div class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Dependencies</h2>
      <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <dt class="text-sm font-medium text-gray-500">Organization Acceptances</dt>
          <dd class="text-sm text-gray-900 mt-1 font-semibold">
            <%= @insurance_plan.org_accepted_plans.active_only.count %>
            <span class="text-gray-500 font-normal ml-2">active organizations</span>
            <span class="text-gray-400 font-normal ml-2">(<%= @insurance_plan.org_accepted_plans.count %> total)</span>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Active Patient Coverages</dt>
          <dd class="text-sm text-gray-900 mt-1 font-semibold">
            <%= @insurance_plan.patient_insurance_coverages.active_only.count %>
            <span class="text-gray-500 font-normal ml-2">active coverages</span>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Total Patient Coverages</dt>
          <dd class="text-sm text-gray-900 mt-1 font-semibold">
            <%= @insurance_plan.patient_insurance_coverages.count %>
            <span class="text-gray-500 font-normal ml-2">total coverages</span>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Claim Submissions</dt>
          <dd class="text-sm text-gray-900 mt-1 font-semibold">
            <%= @insurance_plan.claim_submissions.count %>
            <span class="text-gray-500 font-normal ml-2">submissions</span>
          </dd>
        </div>
      </dl>
    </div>

    <!-- Tabs -->
    <div class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200">
      <div class="border-b border-gray-200">
        <nav class="flex -mb-px" aria-label="Tabs">
          <button onclick="showTab('claim-submissions')" id="tab-claim-submissions" class="tab-button active px-6 py-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">
            Claim Submissions
          </button>
          <button onclick="showTab('rules-matrix')" id="tab-rules-matrix" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent">
            Rules Matrix
          </button>
        </nav>
      </div>

      <!-- Claim Submissions Tab -->
      <div id="content-claim-submissions" class="tab-content p-6">
        <% if @insurance_plan.claim_submissions.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">External Key</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Submitted At</th>
                  <th class="px-6 py-3"></th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @insurance_plan.claim_submissions.limit(10).each do |submission| %>
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm text-gray-900 font-mono"><%= submission.external_submission_key %></td>
                    <td class="px-6 py-4 text-sm text-gray-900"><%= submission.status.humanize %></td>
                    <td class="px-6 py-4 text-sm text-gray-900"><%= submission.submission_method.humanize %></td>
                    <td class="px-6 py-4 text-sm text-gray-500"><%= submission.submitted_at&.strftime("%m/%d/%Y %I:%M %p") || '—' %></td>
                    <td class="px-6 py-4 text-right text-sm">
                      <%= link_to "View", admin_claim_claim_submission_path(submission.claim, submission), class: "text-blue-600 hover:text-blue-800" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <% if @insurance_plan.claim_submissions.count > 10 %>
            <p class="mt-4 text-sm text-gray-500">Showing 10 of <%= @insurance_plan.claim_submissions.count %> submissions</p>
          <% end %>
        <% else %>
          <p class="text-sm text-gray-500">No claim submissions found for this plan.</p>
        <% end %>
      </div>

      <!-- Rules Matrix Tab -->
      <div id="content-rules-matrix" class="tab-content p-6 hidden">
        <div class="text-center py-8">
          <p class="text-sm text-gray-500 mb-4">Rules Matrix functionality will be available in a future release.</p>
          <p class="text-xs text-gray-400">This will show plan-scoped rules for PA/referral/document requirements at plan × specialty/procedure level.</p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Actions</h2>
      <div class="flex items-center gap-3 flex-wrap">
        <%= link_to "Edit", edit_admin_insurance_plan_path(@insurance_plan), class: "px-4 py-2 rounded-md text-sm text-white bg-indigo-600 hover:bg-indigo-700" %>
        <% if @insurance_plan.active? && current_user.permissions_for("admin", "insurance_plans", "retire") %>
          <%= form_with url: retire_admin_insurance_plan_path(@insurance_plan), method: :post, local: true, class: "inline" do |f| %>
            <%= f.text_field :retirement_reason, placeholder: "Retirement reason (optional)", class: "border border-gray-300 rounded-md px-3 py-2 text-sm mr-2" %>
            <%= f.submit "Retire", class: "px-4 py-2 rounded-md text-sm text-white bg-red-600 hover:bg-red-700", data: { confirm: "Are you sure you want to retire this plan? This will prevent new coverages from using this plan." } %>
          <% end %>
        <% end %>
        <% if @insurance_plan.retired? && current_user.permissions_for("admin", "insurance_plans", "restore") %>
          <%= button_to "Restore", restore_admin_insurance_plan_path(@insurance_plan), method: :post, class: "px-4 py-2 rounded-md text-sm text-white bg-green-600 hover:bg-green-700", data: { confirm: "Restore this plan?" } %>
        <% end %>
        <% if current_user.permissions_for("admin", "insurance_plans", "view_audit") %>
          <%= link_to "View Audit", admin_audits_path(model_type: "InsurancePlan", model_id: @insurance_plan.id), class: "px-4 py-2 rounded-md text-sm text-gray-700 bg-white border border-gray-300 hover:bg-gray-50" %>
        <% end %>
      </div>
    </div>

    <script>
      function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
          button.classList.remove('active', 'text-indigo-600', 'border-indigo-600');
          button.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Show selected tab content
        document.getElementById('content-' + tabName).classList.remove('hidden');
        
        // Add active class to selected tab button
        const activeButton = document.getElementById('tab-' + tabName);
        activeButton.classList.add('active', 'text-indigo-600', 'border-indigo-600');
        activeButton.classList.remove('text-gray-500', 'border-transparent');
      }
    </script>
  </div>
</div>

