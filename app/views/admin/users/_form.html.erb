<%= form_with model: @user, url: (@user.persisted? ? admin_user_path(@user) : admin_users_path), class: "space-y-6" do |f| %>
  <div class="rounded-2xl border border-gray-200 bg-white p-8 shadow-sm">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Personal Info</h3>

    <!-- FIXED: Consistent 2-column layout -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <div>
        <label class="block text-sm font-medium text-gray-700">First Name</label>
        <%= f.text_field :first_name,
          placeholder: "Client's First Name",
          class: "mt-2 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Last Name</label>
        <%= f.text_field :last_name,
          placeholder: "Client's Last Name",
          class: "mt-2 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Username</label>
        <%= f.text_field :username,
          placeholder: "Client's Username",
          class: "mt-2 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <%= f.email_field :email,
          placeholder: "Client's Email",
          autocomplete: "email",
          class: "mt-2 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <!-- Spans both columns -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Role</label>
        <%= f.collection_select :role_id, @roles, :id, :role_name,
            { prompt: "Select role" },
            class: "mt-2 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <% unless @user.persisted? %>
        <div class="md:col-span-2">
          <div class="mt-4 rounded-xl border border-gray-200 p-4">
            <h4 class="text-sm font-medium text-gray-800 mb-3">Organization</h4>

            <!-- Mode dropdown -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Invite To</label>
              <select name="user[invite_organization_mode]"
                      id="invite_organization_mode_form"
                      class="mt-1 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm text-gray-800 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <% selected_mode = params.dig(:user, :invite_organization_mode) || "existing" %>
                <option value="existing" <%= "selected" if selected_mode == "existing" %>>Existing organization</option>
                <option value="new" <%= "selected" if selected_mode == "new" %>>New organization</option>
              </select>
            </div>

            <!-- FIXED: Consistent 2-column layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

              <!-- Existing org select -->
              <div id="existing_organization_wrapper_form" class="col-span-1 md:col-span-2 w-full">
                <label class="block text-sm font-medium text-gray-700 mb-1">Existing Organization</label>

                <select name="user[organization_id]"
                        class="mt-1 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm text-gray-800 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                  <option value="">Select Organization</option>
                  <% @organizations&.each do |org| %>
                    <option value="<%= org.id %>" <%= "selected" if params.dig(:user, :organization_id).to_s == org.id.to_s %>>
                      <%= org.name %>
                    </option>
                  <% end %>
                </select>
              </div>


              <!-- New org fields -->
              <%= f.fields_for :organizations_attributes do |of| %>
                <div class="w-full flex flex-col md:flex-row md:gap-4">

                  <!-- Organization Name -->
                  <div id="new_org_name_wrapper_form"
                      class="w-full md:w-1/2"
                      style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Organization Name</label>
                    <%= of.text_field :name,
                          placeholder: "Client's Organization Name",
                          value: params.dig(:user, :organizations_attributes, :name),
                          class: "mt-1 block w-full h-11 rounded-lg border border-gray-200 bg-white px-4 text-sm placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                  </div>

                  <!-- Subdomain -->
                  <div id="new_org_subdomain_wrapper_form"
                      class="w-full md:w-1/2"
                      style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subdomain</label>
                    <div class="mt-1 flex rounded-md shadow-sm w-full">
                      <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-200 bg-gray-50 text-gray-500 text-sm">
                        https://
                      </span>

                      <%= of.text_field :subdomain,
                            placeholder: "client's-organization",
                            value: params.dig(:user, :organizations_attributes, :subdomain),
                            class: "flex-1 rounded-none border border-gray-200 bg-white px-4 h-11 text-sm placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500" %>

                      <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-200 bg-gray-50 text-gray-500 text-sm">
                        .yourdomain.com
                      </span>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Must be unique. Used for tenant subdomain.</p>
                  </div>

                </div>
              <% end %>


            </div>
          </div>
        </div>
      <% end %>

      <% if @user.persisted? %>
        <div>
          <label class="block text-sm font-medium text-gray-700">Status</label>
          <div class="mt-3 flex items-center gap-3">
            <%= f.check_box :locked,
                  { checked: @user.access_locked?, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" },
                  true, false %>
            <span class="text-sm text-gray-700">Locked</span>
          </div>
        </div>
      <% end %>

    </div>

    <div class="mt-6 flex items-center justify-end gap-4">
      <%= link_to "Cancel", admin_users_path, class: "text-sm text-gray-700 hover:text-gray-900" %>
      <%= f.submit (@user.persisted? ? "Save Changes" : "Create Account"),
          class: "inline-flex items-center rounded-lg bg-blue-600 px-5 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-blue-700" %>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var modeSelect = document.getElementById('invite_organization_mode_form');
    var existingWrapper = document.getElementById('existing_organization_wrapper_form');
    var newNameWrapper = document.getElementById('new_org_name_wrapper_form');
    var newSubdomainWrapper = document.getElementById('new_org_subdomain_wrapper_form');

    function toggleOrganizationModeForm() {
      if (!modeSelect) return;
      var mode = modeSelect.value;
      if (mode === 'existing') {
        existingWrapper.style.display = 'block';
        newNameWrapper.style.display = 'none';
        newSubdomainWrapper.style.display = 'none';
      } else {
        existingWrapper.style.display = 'none';
        newNameWrapper.style.display = 'block';
        newSubdomainWrapper.style.display = 'block';
      }
    }

    if (modeSelect) {
      modeSelect.addEventListener('change', toggleOrganizationModeForm);
      toggleOrganizationModeForm();
    }
  });
</script>
