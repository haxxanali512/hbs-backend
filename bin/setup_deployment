#!/usr/bin/env bash

# Setup script for HBS Data Processing deployment

set -e

echo "🚀 Setting up HBS Data Processing for deployment..."

# Check if .kamal directory exists
if [ ! -d ".kamal" ]; then
  echo "📁 Creating .kamal directory..."
  mkdir -p .kamal
fi

# Check if secrets file exists
if [ ! -f ".kamal/secrets" ]; then
  echo "🔐 Creating secrets file template..."
  cat > .kamal/secrets << EOF
# Add your secrets here
KAMAL_REGISTRY_PASSWORD=your_docker_registry_password
RAILS_MASTER_KEY=your_rails_master_key
DATABASE_PASSWORD=your_secure_database_password
REDIS_PASSWORD=your_secure_redis_password
POSTGRES_PASSWORD=your_secure_database_password
EOF
  echo "⚠️  Please update .kamal/secrets with your actual secrets!"
fi

# Check if deploy.yml is configured
if grep -q "your-ec2-ip-address" config/deploy.yml; then
  echo "⚠️  Please update config/deploy.yml with your EC2 IP address!"
fi

if grep -q "your-user" config/deploy.yml; then
  echo "⚠️  Please update config/deploy.yml with your Docker registry username!"
fi

echo "✅ Setup complete!"
echo ""
echo "Next steps:"
echo "1. Update .kamal/secrets with your actual secrets"
echo "2. Update config/deploy.yml with your EC2 IP and Docker registry username"
echo "3. Run: bundle exec kamal build push"
echo "4. Run: bundle exec kamal deploy"
echo "5. Run: bundle exec kamal app exec 'rails db:migrate'"
